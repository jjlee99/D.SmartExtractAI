{% macro content() %}
<script>

const completeId = document.getElementById("adjust_id").value;

const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const zoomLabel = document.getElementById("zoomLabel");
const btnZoomIn = document.getElementById("btnZoomIn");
const btnZoomOut = document.getElementById("btnZoomOut");
const btnReset = document.getElementById("btnReset");

const navigation = document.querySelector('#navigation');
const accordion = document.querySelector('#accordion');
const btnUpdate = document.querySelector('#btnUpdate');
const btnBack = document.querySelector('#btnBack');
let navItemList;


const MIN_SCALE = 0.5;          // ìµœì†Œ/ìµœëŒ€ í™•ëŒ€/ì¶•ì†Œ ë°°ìœ¨
const MAX_SCALE = 10.0;
const CANVAS_MARGIN = 50;        // ìº”ë²„ìŠ¤ ì—¬ë°±
const CORRECTION = 0;           // ë°•ìŠ¤ ê·¸ë¦´ ë•Œ ë³´ì •ê°’
const TEXT_MAX_LEN = 20;       // textì˜ max length ì„¤ì •
const TEXT_MAX_LEN_ROW = 2;         // textareaì˜ rows ì„¤ì •

let loadedBackgroundImage = null;   // ì´ë¯¸ì§€ ì •ë³´
let bgW, bgH, bgX, bgY;         // ìº”ë²„ìŠ¤ ë‚´ ì¹˜ìˆ˜
let scale = 1;                  // í˜„ì¬ í™•ëŒ€/ì¶•ì†Œ ë°°ìœ¨
let offsetX = 0;                // ìº”ë²„ìŠ¤ íŒ¨ë‹ì„ ìœ„í•œ ì˜¤í”„ì…‹
let offsetY = 0;
let mapData = {};               // ì„œë²„ì—ì„œ ë°›ì•„ì˜¨ ë°ì´í„° ì €ì¥ ë° ìˆ˜ì •í•œ ë°ì´í„° ì €ì¥
let imgMap = {};
let imageArray = [];
let imgArrayIdx = 0;
// ì´ë¯¸ì§€ í˜ì´ì§•
let imgMapKey = 0;   // í˜„ì¬ í™”ë©´ì— ê·¸ë ¤ì§€ëŠ” ì´ë¯¸ì§€ idx

let coordinate = {};             // ê·¸ë ¤ì§„ coordinate ì¢Œí‘œ ì •ë³´
let scaleFactor = 0;
let borderDataList = [];         // í™”ë©´ì— ê·¸ë ¤ì§ˆ border ì¢Œí‘œ ì„¤ì •
let dataByPage = {};
let ColNameMap = {};

/**
 * =======================================
 * <h2> ì°¸ê³  </h2>
 * 1. TODOë¡œ í‘œì‹œëœ ë¶€ë¶„ì€ ì‹¤ì œ API ì£¼ì†Œë¡œ ë³€ê²½ í•„ìš”
 * 2. ìˆ˜ì • ì‹œ `mapData`ì— ì €ì¥ëœ ê°’ì„ ë³€ê²½, ìˆ˜ì • ì‹œ mapData ê°’ìœ¼ë¡œ ìˆ˜ì • ë°ì´í„° ì „ì†¡
 * 3. í”„ë¡œì íŠ¸ ë‚´ë¶€ì˜ bootstrap.min.css, bootstrap.min.js, airflowDefaultTheme.f664c2f31c2dd026f579.css ì‚¬ìš©
 * 4. ë°•ìŠ¤ ê·¸ë¦´ ë•Œ ë³´ì •ê°’ì„ ì„ì˜ì˜ ìƒìˆ˜ `CORRECTION`ìœ¼ë¡œ ì¶”ê°€ > ë‹¤ë¥¸ ë¬¸ì„œ í…ŒìŠ¤íŠ¸ í•„ìš”
 * 5. `TEXT_MAX_LEN`, `TEXT_MAX_LEN_ROW` textarea ìƒì„± ì—¬ë¶€ë¥¼ ê²°ì •í•˜ëŠ” ê¸¸ì´ì˜ ê°’, textarea rows ì„¤ì • ê°’ > ì¶”í›„ ë³€ê²½
 * =======================================
 */

/**
 * ì´ˆê¸°í™” í•¨ìˆ˜
 */
function init() {
    document.addEventListener('DOMContentLoaded', async () => {
        await loadData();
        eventListeners();
    });
}


/**
 * ì„œë²„ì—ì„œ ë°ì´í„°(ì´ë¯¸ì§€ URL ë° ì˜ì—­ ì •ë³´)ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜
 */
const loadData = async () => {

    try {
        await loadColumnMapping(); 
    } catch (e) {
        console.error('ì»¬ëŸ¼ ë§µí•‘ ë¡œë“œ ì‹¤íŒ¨:', e);
    }
    
    if (!completeId) {
        alert('complete_id ì •ë³´ë¥¼ ì¡°íšŒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return false;
    }

    $.ajax({
        url: `/adjust/adjust_load/${completeId}`, // âœ… url ì„¤ì • í•„ìš”
        type: "GET",
        success: async function(res) {
            console.log("ë°ì´í„° ë¡œë“œ ì„±ê³µ", res);
            
            mapData = res.data;
            imgMap = res.imgs;
            imageArray = Object.values(imgMap);

            await buildBorderDataIndex(mapData);

            // ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„°ë¡œ objects ë°°ì—´ì„ ì´ˆê¸°í™”í•˜ê³  IDë¥¼ í• ë‹¹
            await render(mapData, imgMap);
            
            // ì´ë¯¸ì§€ë¥¼ ë¡œë“œí•˜ê³  ìº”ë²„ìŠ¤ì— ê·¸ë¦½ë‹ˆë‹¤.
            loadBackground(imgMap); // âœ… previewUrl : íŒŒì¼ê²½ë¡œ+íŒŒì¼ëª…ìœ¼ë¡œ ì„ì‹œ ì„¤ì • -- ì‹¤ì„œë²„ êµ¬í˜„ ì‹œ í™•ì¸
        },
        error: function(err) {
            console.error('Fetch ì—ëŸ¬:', err);
        }
    }); 
};



// --------------------------------------------------------------------------------------------------------------------
//     date render ë° accordion í•˜ìœ„ dom ìƒì„±
// --------------------------------------------------------------------------------------------------------------------


/**
 * ìµœì´ˆ ì‹¤í–‰ì‹œ pageNumì„ ê¸°ì¤€ìœ¼ë¡œ í•˜ëŠ” dataByPage ìƒì„±
 * @param data
 * @returns dataByPage pageNumì„ ê¸°ì¤€ìœ¼ë¡œ í•˜ëŠ” data ë°°ì—´
 */
function buildBorderDataIndex(data) {
    dataByPage = {};
    // 1. ë§µí•‘ ê°ì²´ ì •ì˜
    const keyMap = {
        'title_area': 'ì†ì„± ì˜ì—­',
        'data_area': 'ë°ì´í„° ì˜ì—­'
        // í•„ìš”í•œ ë‹¤ë¥¸ ë§µí•‘ì´ ìˆë‹¤ë©´ ì—¬ê¸°ì— ì¶”ê°€í•©ë‹ˆë‹¤.
    };

    let navKeys = Object.keys(data);
    navKeys.forEach(navKey => {
        if (!navKey) return;
        const safeNavKey = navKey.replace(/\s+/g, '_');

        // 3. ë§µí•‘ ì ìš©: keyMapì— safeNavKeyê°€ ìˆìœ¼ë©´ ë³€í™˜ëœ ê°’ ì‚¬ìš©, ì—†ìœ¼ë©´ safeNavKey ê·¸ëŒ€ë¡œ ì‚¬ìš©
        const displayNavKey = keyMap[safeNavKey] || safeNavKey;

        console.log(`buildBorderDataIndex navKey í‚¤: ${displayNavKey} (ì›ë³¸: ${safeNavKey}) =====`); // ì¶œë ¥ ì‹œ ë³€í™˜ëœ í‚¤ ì‚¬ìš©
        
        const rowArray = mapData[navKey];
        rowArray.forEach((rowElement, rowIdx) => {
            if (typeof rowElement === "object") {
                const fieldKeys = Object.keys(rowElement);
                fieldKeys.forEach(fieldKey => {
                    const element = rowElement[fieldKey];

                    if (typeof element === 'object' && element !== null && element.page_num !== undefined) {
                        const pageNum = element.page_num;
                        if (!dataByPage[pageNum]) {
                            dataByPage[pageNum] = [];
                        }

                        dataByPage[pageNum].push({
                            navKey: safeNavKey,
                            displayKey : displayNavKey,         // í…Œì´ë¸” í‚¤ 
                            rowIdx: rowIdx,             // í–‰ 
                            fieldKey: fieldKey,       // í•„ë“œ í‚¤ 
                            box: element.block_box,   // block_box ë°ì´í„°
                            section_class_id : element.section_class_id,
                            structed_text: element.structed_text, 
                            default_text: element.default_text,
                            section_row: element.section_row,
                            section_col: element.section_col,
                        });
                    }
                });
            }
        });
    });

    console.log('buildBorderDataIndex end:', dataByPage);
}

/**
 * data render
 * @param data
 */
function render(data, imgMap) {

    console.log('function render data:', data);

    // ì´ë¯¸ì§€ í˜ì´ì§• ê´€ë ¨ ìƒì„±
    let imgKeys = Object.keys(imgMap);
    let pageCnt = imgKeys.length;
    
    let pagination = document.querySelector('.pagination'); // ul
    let prevBtn = document.querySelector('.prev'); // li

    if (pageCnt > 1) {
        let idx = 1;
        let liElements = [];
        imgKeys.forEach(key => {
            console.log(`loadBackground imgKeys ===== í‚¤: ${key} =====`);

            let liElement = document.createElement('li');
            liElement.classList.add('page-el-li');
            // pageCnt ë”°ë¼ ë°˜ë³µë¬¸ ì²˜ë¦¬
            let a = document.createElement('a');
            a.textContent = idx++;
            a.setAttribute('data-imageIdx', key);
            
            liElement.appendChild(a);
            liElements.push(liElement);
        });
        prevBtn.after(...liElements);
        let pageliList = document.querySelectorAll('.page-el-li');
        pageliList[0].classList.add('active');

    } else if (pageCnt <= 1) {
        pagination.style.display = "none";
    }

    imgArrayIdx = 1;
    imgMapKey = 1;

    updateUIForPage(imgArrayIdx);
}


/**
 * í˜ì´ì§€ ë²ˆí˜¸ë¡œ ë„¤ë¹„ê²Œì´ì…˜ê³¼ ì½˜í…ì¸  render
 * @param {number} pageNum - í˜ì´ì§€ ë²ˆí˜¸
 */
function updateUIForPage(pageNum) {
    console.log(`updateUIForPage pageNum: ${pageNum} `);
    
    imgArrayIdx = pageNum;

    const allPageLi = document.querySelectorAll('.page-el-li');
    allPageLi.forEach(li => {
        const a = li.querySelector('a');
        if (a && parseInt(a.textContent, 10) === pageNum ) {
            li.classList.add('active');
        } else {
            li.classList.remove('active');
        }
    });

    navigation.innerHTML = '';

    // í˜„ì¬ í˜ì´ì§€ì˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const dataForPage = dataByPage[pageNum];

    if (!dataForPage || dataForPage.length === 0) {
        console.warn(`í˜ì´ì§€ ${pageNum}ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`);
        accordion.innerHTML = '<div style="padding: 15px; border: 1px solid #ddd;">ì´ í˜ì´ì§€ì—ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }

    // nav ìƒì„±
    const navKeysOnPage = new Map(dataForPage.map(element => [element.navKey, element.displayKey])); // ğŸ‘ˆ Map ê°ì²´ë¡œ ë³€ê²½


    console.log(`í˜ì´ì§€ ${pageNum}ì˜ nav í‚¤:`, navKeysOnPage);

    navKeysOnPage.forEach((displayLabel, originalKey) => {
        if (!originalKey) return;
        navigation.insertAdjacentHTML('beforeend', ` <li class="nav-item" data-key=${originalKey}><a class="nav-link" href="#">${displayLabel}</a></li>`);
    });

    navItemList = document.querySelectorAll('.nav-item');

    if (navItemList.length > 0) {
        const firstKey = navItemList[0].dataset.key;
        renderContent(pageNum, firstKey);
    } else {
        accordion.innerHTML = '<div style="padding: 15px; border: 1px solid #ddd;">í‘œì‹œí•  ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    }
}

/**
 * ì„ íƒëœ navigationì˜ key, value render
 * @param pageNum - í˜ì´ì§€ ë²ˆí˜¸
 * @param selectedKey - navigationì—ì„œ ì„ íƒëœ keyê°’
 */
function renderContent(pageNum, selectedKey) {
    accordion.innerHTML = '';

    const dataForPage = dataByPage[pageNum];

    if (!dataForPage) {
        console.warn(`renderContent: í˜ì´ì§€ ${pageNum} ë°ì´í„° ì—†ìŒ`);
        return;
    }

    const pageInfo = dataByPage[imgArrayIdx];
    const rowsGrouped = {}; 
    
    pageInfo.forEach(element => {
        if (element.navKey !== selectedKey) {
            return;
        }

        const rowIdx = element.rowIdx;
        if (!rowsGrouped[rowIdx]) {
            rowsGrouped[rowIdx] = {};
        }

        rowsGrouped[rowIdx][element.fieldKey] = {
            block_box: element.box,
            structed_text: element.structed_text,
            section_class_id : element.section_class_id,
            default_text: element.default_text, 
            section_row: element.section_row,  
            section_col: element.section_col,
        };
    });
    
    const sortedRowIndices = Object.keys(rowsGrouped).sort((a, b) => a - b);
    sortedRowIndices.forEach(rowIdx => {
        const rowObject = rowsGrouped[rowIdx];
        const numericRowIdx = parseInt(rowIdx, 10);

        const htmlDivElement = createAccordionItemElement(numericRowIdx, rowObject);
        accordion.appendChild(htmlDivElement);
    });

    // keyê°’ active ì„¤ì •
    if (navItemList && navItemList.length > 0) {
        navItemList.forEach(element => {
            element.classList.toggle('active', element.dataset.key === selectedKey);
        });
    }
}

/**
 * í•˜ë‚˜ì˜ ì•„ì½”ë””ì–¸ ì•„ì´í…œ ì „ì²´ DOM ìš”ì†Œë¥¼ ìƒì„±í•˜ëŠ” ë©”ì¸ í•¨ìˆ˜
 * @param {string} index - ì•„ì½”ë””ì–¸ ì•„ì´í…œì˜ ì¸ë±ìŠ¤ (0ë¶€í„° ì‹œì‘)
 * @param {object} dataObject - í…Œì´ë¸” í–‰ë“¤ì„ ë§Œë“¤ ë°ì´í„° ê°ì²´
 * @returns {HTMLDivElement} - ìƒì„±ëœ ìµœìƒìœ„ div ìš”ì†Œ
 */
function createAccordionItemElement(index, dataObject) {
	
	
	const panelBody = document.createElement('div');
	panelBody.classList.add('panel-body');



	// í…Œì´ë¸” ìƒì„±
	const table = document.createElement('table');
    table.classList.add('table', 'mb-0');
    
    // colgroup ìƒì„±
    const colgroup = document.createElement("colgroup");
    const col1 = document.createElement("col");
    col1.style.width = "15%";
    const col2 = document.createElement("col");
    col2.style.width = "10%";
    const col3 = document.createElement("col");
    col3.style.width = "37.5%";
    const col4 = document.createElement("col");
    col4.style.width = "37.5%";


	const thead = document.createElement('thead');
    thead.classList.add('thead-highlight');
    const Style = 'border-right: 1px solid #dee2e6; text-align: center;';
    const Style2 = 'border-right: 1px solid #dee2e6;';
	thead.innerHTML = `
    <tr>
        <td style="${Style2}">êµ¬ì—­ëª…</td>
        <td style="${Style}">í–‰ë ¬</td>
        <td style="${Style2}">ì˜¤ë¥˜ í…ìŠ¤íŠ¸</td>
        <td style="${Style2}">ìˆ˜ì • í…ìŠ¤íŠ¸</td>
    </tr>
    
    `;

    // TODO : ì´ê³³ì— íšŒìƒ‰ ìŒì˜ì²˜ë¦¬
	const tbody = document.createElement('tbody');

	// dataObjectì˜ ê° í‚¤-ê°’ ìŒì— ëŒ€í•´ í…Œì´ë¸” í–‰ ìƒì„±
	Object.keys(dataObject).forEach((key) => {
		if (typeof dataObject[key] === "object") {
			console.log('createAccordionItemElement > key:', key, 'value:', dataObject[key]);
			
            const tableRow = createTableRowElement(key, dataObject[key]);            
            if (tableRow != ``) {
                tbody.appendChild(tableRow);
            }
		}
	});

    colgroup.appendChild(col1);
    colgroup.appendChild(col2);
    colgroup.appendChild(col3);
    colgroup.appendChild(col4);
    table.appendChild(colgroup);
	table.appendChild(thead);
	table.appendChild(tbody);
	panelBody.appendChild(table);

	return panelBody;
}



/**
 * ì»¬ëŸ¼ëª… ë§µí•‘ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°. 
 * @returns {Promise<void>}
 */
function loadColumnMapping() {
    return fetch('/adjust/section_mapping') 
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success' && Array.isArray(data.mapping)) {
                // ë§µí•‘ ë¦¬ìŠ¤íŠ¸ë¥¼ 'ì˜ë¬¸ êµ¬ì—­ëª…': 'í•œê¸€ êµ¬ì—­ëª…' í˜•íƒœì˜ ë”•ì…”ë„ˆë¦¬ë¡œ ë³€í™˜
                data.mapping.forEach(item => {
                    ColNameMap[item.id] = item.name;
                });
                console.log("âœ… ì»¬ëŸ¼ ë§µí•‘ ë¡œë“œ ì™„ë£Œ:", ColNameMap);
            } else {
                console.error("ì»¬ëŸ¼ ë§µí•‘ ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }
        })
        .catch(error => {
            console.error('ì»¬ëŸ¼ ë§µí•‘ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ë¹ˆ ê°ì²´ë¡œ ìœ ì§€í•˜ì—¬ í”„ë¡œê·¸ë¨ ì¤‘ë‹¨ ë°©ì§€
            ColNameMap = {}; 
        });
}



/**
 * í…Œì´ë¸” í–‰(tr) DOM ìš”ì†Œë¥¼ ìƒì„±í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
 * @param {string} key - ë°ì´í„°ì˜ í‚¤
 * @param {object} valueObject - ë°ì´í„°ì˜ ê°’ ê°ì²´ (ì˜ˆ: { block_box: [...], structed_text: "..." })
 * @returns {HTMLTableRowElement} - ìƒì„±ëœ tr ìš”ì†Œ
 */


 
function createTableRowElement(key, valueObject) {
    const tr = document.createElement('tr');
    tr.classList.add('detail-row');
    const Style = 'border-right: 1px solid #dee2e6; text-align: center;';
    const Style2 = 'border-right: 1px solid #dee2e6;';
    // block_box ì¢Œí‘œê°€ ìˆë‹¤ë©´ data-* ì†ì„±ìœ¼ë¡œ ì¶”ê°€
    if (valueObject.block_box && valueObject.block_box.length === 4) {
        borderDataList.push(valueObject.block_box);

        tr.setAttribute('data-coordinate-x', valueObject.block_box[0]);
        tr.setAttribute('data-coordinate-y', valueObject.block_box[1]);
        tr.setAttribute('data-coordinate-w', valueObject.block_box[2]);
        tr.setAttribute('data-coordinate-h', valueObject.block_box[3]);
    }


    // 1. êµ¬ì—­ëª… <td> (ìˆ˜ì • ë¶€ë¶„) --------------------------------
    const tdZoneName = document.createElement('td');
    let finalDisplay = valueObject.section_class_id; // ê¸°ë³¸ê°’ì€ ì›ë³¸ key (ì˜ë¬¸ëª…)ìœ¼ë¡œ ì„¤ì •
    //  ë§µí•‘ ë”•ì…”ë„ˆë¦¬(ColNameMap)ë¥¼ ìˆœíšŒí•˜ë©° ìœ ì‚¬ ì¼ì¹˜í•˜ëŠ” ì»¬ëŸ¼ëª… ì°¾ìŒ
    //    Object.keys(ColNameMap)ëŠ” ë§µí•‘ ë”•ì…”ë„ˆë¦¬ì˜ í‚¤ (ì˜ˆ: 'FLR_STRUCT_TYPE') ë¦¬ìŠ¤íŠ¸ë¥¼ ë°˜í™˜
    const columnKeys = Object.keys(ColNameMap);

    for (let i = 0; i < columnKeys.length; i++) {
        const mapKey = columnKeys[i]; // ë§µí•‘ ë¦¬ìŠ¤íŠ¸ì˜ í‚¤ (ì˜ˆ: 'FLR_STRUCT_TYPE')
        console.log(`Comparing valueObject.section_class_id: ${valueObject.section_class_id} with mapKey: ${mapKey}`);
        // **2. í•µì‹¬ ìœ ì‚¬ ì¼ì¹˜ ê²€ì‚¬:**
        // section_class_idì™€ mapKeyê°€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
        if (valueObject.section_class_id == mapKey) {
            finalDisplay = ColNameMap[mapKey];
            // ì¼ì¹˜í•˜ëŠ” ê²ƒì„ ì°¾ì•˜ìœ¼ë¯€ë¡œ ë°˜ë³µì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤.
            break; 
        }
    }
    tdZoneName.textContent = finalDisplay; 
    tdZoneName.style = Style2;
    
    // ì›ë³¸ keyëŠ” data ì†ì„±ìœ¼ë¡œ ìœ ì§€
    tdZoneName.setAttribute('data-column-nm', key);
    
    tr.appendChild(tdZoneName);
    

    
    // 2. í–‰ë ¬ <td> (ì›í•˜ëŠ” í˜•ì‹: section_row/section_col)
    const tdRowCol = document.createElement('td');
    // section_rowì™€ section_colì€ valueObject ë‚´ì— ìˆìœ¼ë¯€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
    const rowNum = valueObject.section_row !== undefined ? valueObject.section_row : '?';
    const colNum = valueObject.section_col !== undefined ? valueObject.section_col : '?';
    tdRowCol.textContent = `${rowNum}/${colNum}`;
    tdRowCol.style = Style; 
    tr.appendChild(tdRowCol);

    // 3. ì˜¤ë¥˜ í…ìŠ¤íŠ¸ <td> (structed_text) -
    const tdErrorText = document.createElement('td');
    const errorText = valueObject.structed_text || '';
    tdErrorText.textContent = errorText; 
    tdErrorText.style = Style2;
    tr.appendChild(tdErrorText);

    // ì…ë ¥ ìš”ì†Œ ë¶€ë¶„ ê°ì£¼ì²˜ë¦¬
    {# let errorInputElement;
    if (errorText.length > TEXT_MAX_LEN) {
        errorInputElement = document.createElement('textarea');
        errorInputElement.rows = TEXT_MAX_LEN_ROW;
    } else {
        errorInputElement = document.createElement('input');
        errorInputElement.type = 'text';
    }
    
    // ì´ ì…ë ¥ í•„ë“œì˜ nameì€ ê¸°ì¡´ê³¼ ê°™ì´ keyë¥¼ ì‚¬ìš©í•˜ì—¬ ë°±ì—”ë“œ ìˆ˜ì • ë°ì´í„°ë¥¼ ë§¤í•‘í•©ë‹ˆë‹¤.
    errorInputElement.name = key; 
    errorInputElement.value = errorText; 
    errorInputElement.classList.add('form-control');

    tdErrorText.appendChild(errorInputElement);
    tr.appendChild(tdErrorText); #}

    // 4. ìˆ˜ì • í…ìŠ¤íŠ¸ <td> (default_text) - ë‹¨ìˆœ í…ìŠ¤íŠ¸ë¡œ í‘œì‹œ
    const tdCorrectionText = document.createElement('td');
    const correctionText = valueObject.default_text || '';

    tdCorrectionText.textContent = correctionText; 
    tdCorrectionText.style = Style2;
    tr.appendChild(tdCorrectionText);

    return tr;
}



/**
 * ========================================================================================================================
 *     í…Œì´ë¸” ê´€ë ¨ í•¨ìˆ˜
 * ======================================================================================================================
 */

/**
 * ì¢Œí‘œê°’/ë°°ê²½ì´ë¯¸ì§€ ì´ˆê¸°í™” í•¨ìˆ˜
 */
function resetCoordinate() {
    coordinate = {};
    drawBackgroundImg();
}

/**
 * ì•„ì½”ë””ì–¸ row click ì´ë²¤íŠ¸
 * @param e
 */
function rowClickEvent(e) {
    const clickRow = e.target.closest('.detail-row');
    if (!clickRow) return;

    // ë°°ê²½ìƒ‰ ì²˜ë¦¬
    const clickedRowElement = document.querySelector('.detail-row.bg-color-ddd');
    if (clickedRowElement) {
        clickedRowElement.classList.remove('bg-color-ddd');
    }
    clickRow.classList.add('bg-color-ddd');

    const { coordinateX, coordinateY, coordinateW, coordinateH } = clickRow.dataset;
    if (coordinate != {} 
            && (coordinate.x === coordinateX && coordinateY === coordinate.y && coordinate.w === coordinateW && coordinate.h === coordinateH)) {
        return;
    }

    resetCoordinate();

    if (coordinateX && coordinateY && coordinateW && coordinateH) {
        coordinate = { x : coordinateX, y:coordinateY, w:coordinateW, h:coordinateH};
        console.log(`rowClickEvent coordinate : x=${coordinate.x}, y=${coordinate.y}, w=${coordinate.w}, h=${coordinate.h}`);

        drawBox(coordinate);
    }
}

/**
 * input ê°’ ë³€ê²½ ì´ë²¤íŠ¸
 * @param e
 */ 
function inputChangeEvent(e) {
    if (!e.target.classList.contains('form-control')) return false;

    const name = e.target.name;
    const value = e.target.value;
    
    const activeNav = document.querySelector('.nav-item.active');
    const openAccordion = document.querySelector('.panel-collapse.collapse.in');

    if (!activeNav && !openAccordion) return false;

    const tableId = activeNav.dataset.key;
    const rowId = openAccordion.getAttribute('row-idx');
    
    if (mapData[tableId] && mapData[tableId][rowId] && mapData[tableId][rowId][name]) {
        const changeKey = mapData[tableId][rowId][name];
        changeKey.structed_text = value;
    } else {
        alert('ìˆ˜ì •í•  ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        console.error('!changeKey tableId:', tableId, ' rowId:', rowId, ' name:', name);
    }
}


/**
 * navigation ë³€ê²½ ì´ë²¤íŠ¸
 * @param e
 */ 
function navigationActiveChangeEvent(e) {
    e.preventDefault();
    
    const clickLink = e.target.closest('.nav-item');
    if (!clickLink) return;

    // í˜„ì¬ active keyì™€ clickëœ key ê°’ì´ ë™ì¼í•œì§€ í™•ì¸
    const selectKey = clickLink.dataset.key;
    const activeKey = document.querySelector('.nav-item.active')?.dataset.key;
    if (activeKey === selectKey) return;
    
    // ê·¸ë ¤ì§„ box ì¢Œí‘œ, ì˜ì—­ì¢Œí‘œ ì´ˆê¸°í™”
    resetCoordinate();

    // border ì˜ì—­ ì´ˆê¸°í™”
    borderDataList = [];

    // mapDataì˜ key ê°’ìœ¼ë¡œ ìƒì„¸ ë°ì´í„° ì¡°íšŒ
    if (mapData && mapData[selectKey]) { 
        renderContent(imgArrayIdx, selectKey);
    }

    drawBackgroundImg();
}

/**
 * ë°ì´í„° ìˆ˜ì • ì´ë²¤íŠ¸ ì²˜ë¦¬
 * @param e
 */
function handleDataUpdate(e) {
    e.preventDefault();

    if (!confirm('ì „ì²´ ë°ì´í„°ë¥¼ ì¡°ê±´ë³„ êµì •ì‚¬ì „ì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    // ğŸ’¡ ë°±ì—”ë“œ ìš”êµ¬ ì‚¬í•­(message: "'data' field missing...")ì— ë§ì¶° mapDataë¥¼ 'data' í•„ë“œ ì•ˆì— ë˜í•‘í•©ë‹ˆë‹¤.
    const requestPayload = {
        data: mapData
    };

    console.log('update data :', mapData);
    console.log('request payload:', requestPayload)

    // fetch ëŒ€ì‹  $.ajaxë¥¼ ì‚¬ìš©í•˜ì—¬ loadDataì™€ ì¼ê´€ì„±ì„ ìœ ì§€í•˜ë©° ë°ì´í„° ì—…ë°ì´íŠ¸
    $.ajax({
        url: `/adjust/edit/${completeId}`,
        type: "POST", // ë°ì´í„° ìˆ˜ì •ì´ë¯€ë¡œ POST
        contentType: 'application/json', // ì„œë²„ë¡œ ë³´ë‚´ëŠ” ë°ì´í„° í˜•ì‹ ì§€ì •
        // CSRF í† í° í—¤ë”ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.
        
        data: JSON.stringify(requestPayload), // JavaScript ê°ì²´ë¥¼ JSON ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ì „ì†¡
        
        // loadDataì˜ successì™€ ë™ì¼í•œ êµ¬ì¡°
        success: function(data) {
            console.log('ì„œë²„ ì‘ë‹µ:', data);

            if (data.status === 'redirect' && data.url) {
                // í´ë¼ì´ì–¸íŠ¸ì—ì„œ í˜ì´ì§€ ë³€ê²½ì„ ì‹¤í–‰ (ì´ë•Œ flash ë©”ì‹œì§€ê°€ í‘œì‹œë¨)
                window.location.href = data.url; 
            } else {
                console.log('ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìœ¼ë‚˜ ë¦¬ë””ë ‰ì…˜ì´ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
            
            // alert('ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.'); // custom UI í•„ìš”
            console.log('ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
        },
        
        // loadDataì˜ errorì™€ ë™ì¼í•œ êµ¬ì¡°
        error: function(err) {
            console.error('Ajax ì—ëŸ¬:', err);
            // alert('ë°ì´í„° ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); // custom UI í•„ìš”
            console.error('ë°ì´í„° ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    });
}

/**
 * ì´ë¯¸ì§€ í˜ì´ì§•ê´€ë ¨ ì´ë²¤íŠ¸ í•¨ìˆ˜
 * @param e
 */
async function changeImageIdxEvent(e) {
    e.preventDefault();
    console.log(`changeImageIdxEvent imgArrayIdx ${imgArrayIdx}`);

    const clickedLi = event.target.closest('li');
    if (clickedLi.classList.contains('prev')) {
        console.log('ì´ì „ ë²„íŠ¼ í´ë¦­');
        if (imgArrayIdx > 1) {
            await changePageElAcvive(Number(imgArrayIdx-1));
        }

    } else if (clickedLi.classList.contains('next')) {
        const imgMapLen = Object.keys(imgMap).length;
        if (imgArrayIdx < imgMapLen) {
            await changePageElAcvive(Number(imgArrayIdx+1));
        }

    } else if (clickedLi.classList.contains('page-el-li')) {
        const clickedaTag = clickedLi.querySelector('a');
        if (clickedaTag && clickedaTag.dataset.imageidx) {
            const pageIndex = Number(clickedaTag.textContent);

            // if(imgMapKey === pageIndex ) return;
            if(imgArrayIdx === pageIndex ) return;

            await changePageElAcvive(pageIndex);
        }

    }
}

/**
    í˜ì´ì§€ ë³€ê²½ ê´€ë ¨ ìˆ˜ì •
*/
function changePageElAcvive(pageIndex) {
    const pageliList = document.querySelectorAll('.page-el-li');
    pageliList.forEach(liElement => {
        const findaTag = liElement.querySelector('a');
        let flag = Number(findaTag.textContent) === pageIndex;
        if (flag) imgMapKey = findaTag.dataset.imageidx;
        liElement.classList.toggle('active', flag);
    });
    imgArrayIdx = Number(pageIndex);
    
    console.log(`í˜ì´ì§€ ë³€ê²½ = í˜„ì¬ imgArrayIdx: ${imgArrayIdx}, imgMapKey: ${imgMapKey}`);

    resetCoordinate();
    // border ì˜ì—­ ì´ˆê¸°í™”
    borderDataList = [];
    
    loadBackground(imgMap);

    updateUIForPage(imgArrayIdx);
}


/**
 * ========================================================================================================================
 *     ìº”ë²„ìŠ¤ ë“œë˜ê·¸ ê´€ë ¨ í•¨ìˆ˜
 * ======================================================================================================================
 */

/**
 * ë§ˆìš°ìŠ¤ ì¢Œí‘œë¥¼ í™”ë©´ ê³µê°„ì—ì„œ ìº”ë²„ìŠ¤ ê³µê°„ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
 * í™•ëŒ€/ì¶•ì†Œ ë° íŒ¨ë‹ì„ ê³ ë ¤í•©ë‹ˆë‹¤.
 * @param {MouseEvent} e ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ê°ì²´.
 * @returns {Array<number>} ìº”ë²„ìŠ¤ ê³µê°„ì˜ [x, y] ì¢Œí‘œ.
 */
function toCanvasCoord(e) {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    return [(x - offsetX) / scale, (y - offsetY) / scale];
}

/**
 * íŠ¹ì • ì§€ì ì„ ì¤‘ì‹¬ìœ¼ë¡œ ìº”ë²„ìŠ¤ë¥¼ í™•ëŒ€ ë˜ëŠ” ì¶•ì†Œí•©ë‹ˆë‹¤.
 * @param {number} factor í™•ëŒ€/ì¶•ì†Œ ë°°ìœ¨ (ì˜ˆ: 1.2ëŠ” í™•ëŒ€).
 * @param {number} cx í™•ëŒ€/ì¶•ì†Œ ì¤‘ì‹¬ì ì˜ X ì¢Œí‘œ (ìº”ë²„ìŠ¤ ê³µê°„).
 * @param {number} cy í™•ëŒ€/ì¶•ì†Œ ì¤‘ì‹¬ì ì˜ Y ì¢Œí‘œ (ìº”ë²„ìŠ¤ ê³µê°„).
 */
function zoomAt(factor, cx, cy) {
    const prevScale = scale;
    let newScale = scale * factor;

    // ìƒˆ ë°°ìœ¨ì„ ìµœì†Œ/ìµœëŒ€ í•œê³„ê°’ìœ¼ë¡œ ì œí•œ
    if (newScale < MIN_SCALE) newScale = MIN_SCALE;
    if (newScale > MAX_SCALE) newScale = MAX_SCALE;

    // í™•ëŒ€/ì¶•ì†Œ ì§€ì ì„ ì¤‘ì•™ì— ìœ ì§€í•˜ê¸° ìœ„í•´ ì˜¤í”„ì…‹ ì¡°ì •
    offsetX = cx - (cx - offsetX) * (newScale / prevScale);
    offsetY = cy - (cy - offsetY) * (newScale / prevScale);

    scale = newScale;
    drawBackgroundImg();
}

/**
 * ë§ˆìš°ìŠ¤ íœ  ì´ë²¤íŠ¸: í™•ëŒ€/ì¶•ì†Œ
 * @param e
 */
function handleWheel(e) {
    e.preventDefault();
    let factor = e.deltaY < 0 ? 1.1 : 0.9;
    const [cx, cy] = toCanvasCoord(e);
    zoomAt(factor, cx, cy);
};







/**
 * ========================================================================================================================
 *      ì´ë¯¸ì§€ ê´€ë ¨ í•¨ìˆ˜
 * ========================================================================================================================
 */


/**
 * ë°°ê²½ ì´ë¯¸ì§€ì˜ í¬ê¸°ì™€ ìœ„ì¹˜ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
 * @param {HTMLImageElement} img - ë°°ê²½ ì´ë¯¸ì§€ ê°ì²´
 */
function calculateBackgroundDimensions(img) {
    const parent = canvas.parentElement;
    canvas.width = parent.clientWidth;
    canvas.height = parent.clientHeight;

    // ì¢…íš¡ë¹„ë¥¼ ìœ ì§€í•˜ë©° ìº”ë²„ìŠ¤ì— ë§ê²Œ ì´ë¯¸ì§€ í¬ê¸° ê³„ì‚°
    const imgAspect = img.width / img.height;
    const canvasAspect = canvas.width / canvas.height;

    // ìº”ë²„ìŠ¤ ì—¬ë°±
    const innerWidth = canvas.width - CANVAS_MARGIN * 2;
    const innerHeight = canvas.height - CANVAS_MARGIN * 2;

    // ê°€ë¡œ/ì„¸ë¡œ ë” ê¸´ ê³³ì— ë§ì¶”ê³  ì—¬ë°± ê³ ë ¤
    scaleFactor = imgAspect > canvasAspect
        ? innerWidth / img.width : innerHeight / img.height;

    bgW = img.width * scaleFactor;
    bgH = img.height * scaleFactor;
    bgX = (canvas.width - bgW) / 2;
    bgY = (canvas.height - bgH) / 2;
}

/**
 * ë°°ê²½ ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
 */
function drawBackgroundImg() {
    if (!loadedBackgroundImage) {
        console.error('ì´ë¯¸ì§€ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
    }

    calculateBackgroundDimensions(loadedBackgroundImage);

    ctx.setTransform(scale, 0, 0, scale, offsetX, offsetY);
    // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    // ë°°ê²½ ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
    ctx.drawImage(loadedBackgroundImage, bgX, bgY, bgW, bgH);

    // ì™¸ê³½ì„  ê·¸ë¦¬ê¸°
    if (borderDataList !== []) {
        borderDataList.forEach(element => {
            let x = element[0], y = element[1], w = element[2], h = element[3];

            const cal_br_x = (parseFloat(x) * scaleFactor) + bgX + CORRECTION;
            const cal_br_y = (parseFloat(y) * scaleFactor) + bgY + CORRECTION;
            const cal_br_w = parseFloat(w) * scaleFactor;
            const cal_br_h = parseFloat(h) * scaleFactor;
            
            // í…Œë‘ë¦¬ ë‘ê»˜ ì„¤ì •
            ctx.lineWidth = 1;
            ctx.strokeStyle = 'red';       
            ctx.strokeRect(cal_br_x, cal_br_y, cal_br_w, cal_br_h); 
        });
    }

    // ì¤Œ ë°°ìœ¨ ì—…ë°ì´íŠ¸
    zoomLabel.textContent = "Zoom level: " + scale.toFixed(4);

    if (coordinate) {
        drawBox(coordinate);
    }
}

/**
 * ë°°ê²½ ì´ë¯¸ì§€ ì—¬ë°±ê³¼ í¬ê¸°ì¡°ì ˆì„ ìœ„í•´ ì„¸íŒ…í•˜ëŠ” í•¨ìˆ˜
 */
function loadBackground(imgMap) {
    // í˜„ì¬ ì´ë¯¸ì§€ ì£¼ì†Œ ë¶ˆëŸ¬ì˜¤ê¸°
    image = imageArray[imgArrayIdx-1];

    const backgroundImage = new Image();
    backgroundImage.src = image;

    backgroundImage.onload = function() {
        loadedBackgroundImage = backgroundImage;
        drawBackgroundImg();
    };

    backgroundImage.onerror = function() {
        console.error('ì´ë¯¸ì§€ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', image);
    }
}

     

/**
 * ì¢Œí‘œ ê°’ìœ¼ë¡œ ìº”ë²„ìŠ¤ì— ë°•ìŠ¤ ê·¸ë¦¬ê¸°
 * @param coordinate
 */
const drawBox = (coordinate) => {
    // ì›ë³¸ ì´ë¯¸ì§€ì™€ ìº”ë²„ìŠ¤ ë¹„ìœ¨ì— ë§ì¶°ì„œ ì¢Œí‘œê°’ ì¡°ì •
    let x_scaled = parseFloat(coordinate.x) * scaleFactor;
    let y_scaled = parseFloat(coordinate.y) * scaleFactor;
    let w_scaled = parseFloat(coordinate.w) * scaleFactor;
    let h_scaled = parseFloat(coordinate.h) * scaleFactor;

    // 2. ìµœì¢… ì¢Œí‘œ ê³„ì‚°: ìº”ë²„ìŠ¤ ì»¨í…ìŠ¤íŠ¸ì˜ í˜„ì¬ ë³€í™˜ ìƒíƒœ(scale, offsetX, offsetY)ì— ë§ì¶°
    //    fillRectëŠ” ìº”ë²„ìŠ¤ ê³µê°„ ë‚´ì˜ (bgX, bgY) ì§€ì ì—ì„œë¶€í„° ê·¸ë¦¬ê¸° ì‹œì‘í•´ì•¼ í•¨.
    let finalX = x_scaled + bgX - CORRECTION;
    let finalY = y_scaled + bgY - CORRECTION;

    // 3. CORRECTIONì€ ë³´í†µ ìº”ë²„ìŠ¤ ì„  êµµê¸°/ì„ ëª…ë„ ë³´ì •ìš©ì´ë¯€ë¡œ ë„ˆë¹„/ë†’ì´ì—ëŠ” ì œì™¸í•˜ê±°ë‚˜,
    //    ë°•ìŠ¤ë¥¼ ì–‡ê²Œ ê·¸ë¦¬ë ¤ë©´ ë„ˆë¹„/ë†’ì´ì— 2*CORRECTIONì„ ë¹¼ì£¼ëŠ” ê²ƒì„ ê³ ë ¤í•´ì•¼ í•¨
    let finalW = w_scaled + (2 * CORRECTION); // ì„ íƒ ì‚¬í•­: ë³´ì •ê°’ì„ ë„ˆë¹„/ë†’ì´ì— í¬í•¨í•˜ì—¬ ì˜ì—­ì„ ë„“í ìˆ˜ ìˆìŒ
    let finalH = h_scaled + (2 * CORRECTION); // ì„ íƒ ì‚¬í•­: ë³´ì •ê°’ì„ ë„ˆë¹„/ë†’ì´ì— í¬í•¨í•˜ì—¬ ì˜ì—­ì„ ë„“í ìˆ˜ ìˆìŒ

    ctx.fillStyle = "rgba(220, 53, 53, 0.4)";
    ctx.fillRect(finalX, finalY, finalW, finalH);
}


/**
 * ========================================================================================================================
 *     ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
 * =======================================================================================================================
 */
function eventListeners() {
    accordion.addEventListener('click', rowClickEvent);

    accordion.addEventListener('change', inputChangeEvent);

    navigation.addEventListener('click', navigationActiveChangeEvent);

    btnUpdate.addEventListener('click', handleDataUpdate);

    btnBack.addEventListener('click', () => {
        location.href="/back"
    });

    document.querySelector('.pagination').addEventListener('click', changeImageIdxEvent);   

    btnReset.onclick = () => {  // ì´ˆê¸°í™” í´ë¦­ ì‹œ
        scale = 1;
        offsetX = 0;
        offsetY = 0;
        resetCoordinate();
    }

    btnZoomIn.onclick = () => zoomAt(1.2, canvas.width / 2, canvas.height / 2); // í™•ëŒ€ í´ë¦­ ì‹œ

    btnZoomOut.onclick = () => zoomAt(0.8, canvas.width / 2, canvas.height / 2);// ì¶•ì†Œ í´ë¦­ ì‹œ

    canvas.addEventListener("wheel", handleWheel, {
        passive: false
    });
}

init();

</script>
{% endmacro %}