{% extends "appbuilder/base.html" %}
{% import 'appbuilder/general/lib.html' as lib %}

{% block content %}
{{ lib.panel_begin(title, "edit") }}

{% if related_views is defined %}
    <ul class="nav nav-tabs"  style="{{"display: none;" if not related_views else "" }}">
    <li class="active"><a href="#Home" data-toggle="tab">{{ _("Detail") }}</a> </li>
        {% for view in related_views %}
        <li><a href="#{{view.__class__.__name__}}" data-toggle="tab">{{view.title}}</a></li>
        {% endfor %}
        </ul>

        <div class="tab-content">
        {% for view in related_views %}
        <div id="{{view.__class__.__name__}}" class="tab-pane">
        {{ widgets.get('related_views')[loop.index - 1]()|safe }}
    </div>
    {% endfor %}
{% endif %}

{% block edit_form %}
    <div id="Home" class="tab-pane active">
        {{ widgets.get('edit')(form_action=form_action)|safe }}
    </div>
{% endblock %}

{% if related_views is defined %} </div> {% endif %}

{{ lib.panel_end() }}
{% endblock %}

{% block add_tail_js %}
<script src="{{url_for('appbuilder.static',filename='js/ab_keep_tab.js')}}" nonce="{{ baselib.get_nonce() }}"></script>
<script nonce="{{ baselib.get_nonce() }}">
$(document).ready(function() {
    var form = $('#Home form:first');
    
    if (form.length === 0) {
        console.error("Edit form element not found.");
        return;
    }

    // 서버 렌더링 시점에 전달된 pk 값을 사용합니다.
    var pk = {{ pk | tojson }};
    // 유효성 검증 전용 엔드포인트 URL
    var validateUrl = '{{ url_for(".validate_doc_config", pk=pk) }}';
    // 데이터 저장 엔드포인트 URL (폼의 action 속성 사용)
    var saveUrl = form.attr('action'); 
    
    // **Step 2: Save Data Function (AJAX)**
    function saveData(url, data, confirmForce) {
        // 강제 진행이 필요한 경우에만 플래그를 데이터에 추가
        if (confirmForce) {
            data['confirm_force'] = 'true'; 
        }

        $.ajax({
            type: 'POST',
            url: url, // 저장 엔드포인트 (/doc/edit/<pk>)
            contentType: 'application/json',
            dataType: 'json', 
            data: JSON.stringify(data),
            
            success: function(response) {
                if (response.isValid === true && response.redirect) {
                    // DB 업데이트 성공 후 리다이렉트
                    window.location.href = response.redirect;
                } else {
                    // 서버에서 폼 유효성 검증 실패 등 일반적인 오류가 발생한 경우
                    alert(response.message || "저장 처리 중 알 수 없는 오류가 발생했습니다.");
                    window.location.reload(); 
                }
            },
            error: function(xhr) {
                // 저장 요청 자체의 통신 오류 (500, 400 에러)
                try {
                    var errorResponse = JSON.parse(xhr.responseText);
                    alert("저장 오류: " + (errorResponse.message || "서버 응답 오류"));
                } catch(e) {
                    alert("서버 통신 오류가 발생했습니다. (Code: " + xhr.status + ")");
                }
                window.location.reload();
            }
        });
    }


    form.on('submit', function(e) {
        e.preventDefault(); // 기본 폼 제출 동작 차단

        // 폼 데이터를 JSON 객체로 변환
        var formDataObject = {};
        $.each(form.serializeArray(), function(i, field) {
            formDataObject[field.name] = field.value;
        });

        // **Step 1: Validation AJAX Call**
        $.ajax({
            type: 'POST',
            url: validateUrl, // 유효성 검증 엔드포인트 (/doc/validate/<pk>)
            contentType: 'application/json',
            dataType: 'json', 
            data: JSON.stringify(formDataObject),
            
            success: function(response) {
                if (response.isValid === true) {
                    // 유효성 검증 성공 또는 검증 불필요 ('use_yn'='N') -> 바로 저장 요청
                    saveData(saveUrl, formDataObject, false);
                } else if (response.isValid === false && response.needsConfirmation === true) {
                    // 유효성 검증 실패 + 컨펌 필요 응답 처리
                    var detailedMessage = response.details ? 
                                          "\n\n--- 상세 오류 ---\n" + response.details : "";
                    var fullConfirmationMessage = response.confirmationMessage + detailedMessage;
                    
                    if (confirm(fullConfirmationMessage)) {
                        // 사용자가 "OK"를 누른 경우: 강제 진행 플래그를 true로 하여 저장 요청
                        saveData(saveUrl, formDataObject, true);
                    } else {
                        // 취소 시 아무것도 하지 않고 종료
                    }
                } else {
                    // 기타 유효성 검증 오류
                    alert(response.message || "유효성 검증 중 알 수 없는 오류가 발생했습니다.");
                }
            },
            error: function(xhr) {
                // 유효성 검증 요청 자체의 통신 오류 (500, 400 에러 등)
                try {
                    var errorResponse = JSON.parse(xhr.responseText);
                    alert("검증 오류: " + (errorResponse.message || "서버 응답 오류"));
                } catch(e) {
                    alert("서버 통신 오류가 발생했습니다. (Code: " + xhr.status + ")");
                }
                window.location.reload(); // 복구를 위해 새로고침
            }
        });
    });
});
</script>
{% endblock %}
