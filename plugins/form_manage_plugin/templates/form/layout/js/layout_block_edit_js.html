{% macro content() %}
<script>
/**
 * ì´ë¯¸ì§€ ì£¼ì„ ë° ê°ì²´ ì¡°ì‘ ë„êµ¬ë¥¼ ìœ„í•œ ìˆ˜ì • ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤.
 * ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ìº”ë²„ìŠ¤ ê·¸ë¦¬ê¸°, ì‚¬ìš©ì ìƒí˜¸ ì‘ìš©(íŒ¨ë‹, í™•ëŒ€/ì¶•ì†Œ,
 * ì‚¬ê°í˜• ê·¸ë¦¬ê¸°), ê·¸ë¦¬ê³  ì„ íƒ/í¸ì§‘ ê°€ëŠ¥í•œ ê°ì²´ ëª©ë¡ ê´€ë¦¬ë¥¼ ë‹´ë‹¹í•©ë‹ˆë‹¤.
 * ì¶”ê°€ì ìœ¼ë¡œ  ìˆ˜ì •í•  ë°ì´í„° ë¡œë“œë¥¼ í•˜ì—¬ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
 */

// --- ìƒìˆ˜ ë° DOM ìš”ì†Œ ---

// ìº”ë²„ìŠ¤ ë° 2D ì»¨í…ìŠ¤íŠ¸
const canvas = document.getElementById("canvas");   // HTML canvas ìš”ì†Œ
const ctx = canvas.getContext("2d");                // 2D ë Œë”ë§ ì»¨í…ìŠ¤íŠ¸

const MIN_SCALE = 0.5;      // ì¶•ì†Œ ìµœëŒ€ ë°°ìœ¨
const MAX_SCALE = 10.0;     // í™•ëŒ€ ìµœëŒ€ ë°°ìœ¨
const HANDLE_SIZE = 8;      // í•¸ë“¤ í¬ê¸°

// ëª¨ë“  UI ë²„íŠ¼ ë° ì…ë ¥ í•„ë“œ
const btnZoomIn = document.getElementById("btn_zoom_in");
const btnZoomOut = document.getElementById("btn_zoom_out");
const btnPan = document.getElementById("btn_pan");
const btnSelect = document.getElementById("btn_select");
const btnReset = document.getElementById("btn_reset");
const zoomLabel = document.getElementById("zoom_label");
const objectIdBox = document.getElementById("object_id_box");
const rectInput = document.getElementById("rect");
//const docClassIdInput = document.getElementById("doc_class_id");
const layoutClassIdInput = document.getElementById("layout_class_id");
const sectionNameInput = document.getElementById("section_name");
const sectionTypeSelect = document.getElementById("section_type");
const separateBlockTypeSelect = document.getElementById("separate_block_type");
const btnSave = document.getElementById("btn_save");
const selectors = { rectInput, sectionNameInput, sectionTypeSelect, separateBlockTypeSelect };
const blockTableBody = document.querySelector(".block-table tbody");
const btnBack = document.getElementById("btn_back");


/* --- ìƒíƒœ ë³€ìˆ˜ --- */
let mode = null;                // í˜„ì¬ ë„êµ¬ ëª¨ë“œ (null: ì„ íƒ, 'pan': ì´ë™, 'rect': ì˜ì—­ ê·¸ë¦¬ê¸°)
let scale = 1;                  // ìº”ë²„ìŠ¤ì˜ í™•ëŒ€/ì¶•ì†Œ ë°°ìœ¨
let offsetX = 0,                // ìº”ë²„ìŠ¤ ì´ë™(pan) ì‹œì˜ ì˜¤í”„ì…‹
  offsetY = 0;
let backgroundImg = null;       // ë°°ê²½ ì´ë¯¸ì§€
let bgW, bgH, bgX, bgY;         // ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°ìš© ë„ˆë¹„, ë†’ì´, ìœ„ì¹˜
let regionObjects = [];         // ì˜ì—­ë“¤ì„ ì €ì¥í•  ë°°ì—´
let blockObjects = [];          // ë¸”ë¡ë“¤ì„ ì €ì¥í•  ë°°ì—´
let currentId = 1;              // ìƒˆë¡œìš´ ì˜ì—­ì— í• ë‹¹í•  ê³ ìœ  ID
let selectedObject = null;      // í˜„ì¬ ì„ íƒëœ ì˜ì—­
let dragging = false;           // ë§ˆìš°ìŠ¤ ë“œë˜ê·¸ ì¤‘ì¸ì§€ ì—¬ë¶€
let dragType = null;            // ë“œë˜ê·¸ ì‘ì—… ìœ í˜• ('pan', 'move', 'resize')
let startX, startY;             // ë“œë˜ê·¸ ì‹œì‘ ì‹œ ë§ˆìš°ìŠ¤ ì¢Œí‘œ
let dragOffsetX, dragOffsetY;   // ë“œë˜ê·¸ ì‹œì‘ ì‹œ ë§ˆìš°ìŠ¤ ì˜¤í”„ì…‹
let hoverHandleIndex = -1;      // í˜¸ë²„ëœ í¬ê¸° ì¡°ì ˆ í•¸ë“¤ ì¸ë±ìŠ¤ (-1ì´ë©´ ì—†ìŒ)
// let loadImg;                    // í˜„ ë°ì´í„° ì´ë¯¸ì§€ file id
let deleteSecClassIds = [];     // ì‚­ì œëœ ê¸°ì¡´ ì˜ì—­ id ë°°ì—´
let highlightedBlock = null;    // í•˜ì´ë¼ì´íŠ¸í•  ë¸”ë¡ ê°ì²´ë¥¼ ì €ì¥í•˜ëŠ” ì „ì—­ ë³€ìˆ˜

/* --- ìˆ˜ì •í•  ë°ì´í„° ë¡œë“œ ê´€ë ¨ í•¨ìˆ˜ --- */

// âœ… í…ŒìŠ¤íŠ¸ ë°ì´í„° (ì‹¤ì œ AJAX ëŒ€ì²´ìš©) -- ì‹¤ì„œë²„ êµ¬í˜„ ì‹œ ì‚­ì œ í•„ìš”
const testData = {
    imageUrl: "http://ktaor.com/index/data/ckeditor/upload/20182573821_editor_image.jpg",
    regions: [
        {
        sectionClassId: Math.random(),
        rect: { x: 45.09, y: 20.04, w: 2369.75, h: 450 },
        sectionName: 'ì œëª©',
        sectionType: '1',
        separateBlockType: '1'
        },
        {
        sectionClassId: 37,
        rect: { x: 59.88, y: 475.81, w: 2349.95, h: 185 },
        sectionName: 'í‘œ',
        sectionType: '2',
        separateBlockType: '3'
        },
        {
        sectionClassId: 38,
        rect: { x: 69.90, y: 666.16, w: 2349.95, h: 325.82 },
        sectionName: 'í‘œ2',
        sectionType: '2',
        separateBlockType: '3'
        }
    ],
	blocks:[
		{
			blockClassId: 1,
			sectionClassId: 37,
			blockRowNum: 1,
			blockColNum: 1,
			blockType: 'key',
            tableName: 'TB_OCR_BILD_BASIC_INFO',
			columnName: 'LAND_AREA_SQM',
			defaultText: 'ëŒ€ì§€ë©´ì ',
            blockBox: [215, 491, 417, 147]
		},
		{
			blockClassId: 2,
			sectionClassId: 37,
			blockRowNum: 1,
			blockColNum: 2,
			blockType: 'val',
            tableName: 'TB_OCR_BILD_BASIC_INFO',
			columnName: 'LAND_AREA_SQM',
			defaultText: 'm2',
            blockBox: [616, 495, 1626, 147]
		},
		{
			blockClassId: 3,
			sectionClassId: 38,
			blockRowNum: 1,
			blockColNum: 1,
			blockType: 'key',
            tableName: 'TB_OCR_FLR_STATUS',
			columnName: 'FLR_CLASS_TYPE',
			defaultText: 'êµ¬ë¶„',
            blockBox: [224, 686, 393, 111]
		},
		{
			blockClassId: 4,
			sectionClassId: 38,
			blockRowNum: 2,
			blockColNum: 1,
			blockType: 'key',
            tableName: 'TB_OCR_FLR_STATUS',
			columnName: 'FLR_NUM_TEXT',
			defaultText: 'ì¸µë³„',
            blockBox: [623, 685, 1603, 116]
		},
		{
			blockClassId: 15,
			sectionClassId: 38,
			blockRowNum: 2,
			blockColNum: 1,
			blockType: 'val',
            tableName: 'TB_OCR_FLR_STATUS',
			columnName: 'FLR_CLASS_TYPE',
			defaultText: '',
            blockBox: [226, 805, 394, 147]
		},
		{
			blockClassId: 16,
			sectionClassId: 38,
			blockRowNum: 2,
			blockColNum: 2,
			blockType: 'val',
            tableName: 'TB_OCR_FLR_STATUS',
			columnName: 'FLR_NUM_TEXT',
			defaultText: 'ì¸µ',
            blockBox: [233, 1009, 173, 119]
		}
	]
};

// ì„œë²„ì—ì„œ ë°ì´í„°(ì´ë¯¸ì§€ URL ë° ì˜ì—­ ì •ë³´)ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜
const loadData = () => {
    $.ajax({
        url: "/layout/block_load/"+layoutClassIdInput.value, // âœ… url ì„¤ì • í•„ìš”
        type: "GET",
        success: function(res) {
            console.log("ë°ì´í„° ë¡œë“œ ì„±ê³µ", res);
            // ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„°ë¡œ objects ë°°ì—´ì„ ì´ˆê¸°í™”í•˜ê³  IDë¥¼ í• ë‹¹
            regionObjects = res.regions.map(region => ({
                id: "obj" + currentId++,
                ...region
            }));
            blockObjects = res.blocks.map(blocks => ({
                id: "blockObj" + currentId++,
                ...blocks
            }));
            // loadImg = res.atchFileId;// âœ… ì´ë¯¸ì§€ íŒŒì¼ ê³ ìœ  í‚¤ê°’ ì €ì¥ -- í‚¤ê°’ ì„ì‹œ ì„¤ì •. ì‹¤ì„œë²„ êµ¬í˜„ ì‹œ í™•ì¸
            // ì´ë¯¸ì§€ë¥¼ ë¡œë“œí•˜ê³  ìº”ë²„ìŠ¤ì— ê·¸ë¦½ë‹ˆë‹¤.
            loadBackground(res.imageUrl); // âœ… previewUrl : íŒŒì¼ê²½ë¡œ+íŒŒì¼ëª…ìœ¼ë¡œ ì„ì‹œ ì„¤ì • -- ì‹¤ì„œë²„ êµ¬í˜„ ì‹œ í™•ì¸
        },
        error: function(err) {
            /** âœ… í•´ë‹¹ êµ¬ê°„ í…ŒìŠ¤íŠ¸ìš© ì‚¬ìš©ì¤‘ì¸ ë¬¸ì œë¡œ ì‹¤ì„œë²„ êµ¬í˜„ ì‹œ í›„ì²˜ë¦¬ í•„ìš” */
            //alert('ë°ì´í„° ì½ì–´ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.');

            // âœ… í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¡œ ëŒ€ì²´ -- ì‹¤ì„œë²„ êµ¬í˜„ ì‹œ ì‚­ì œ í•„ìš”
            regionObjects = testData.regions.map(region => ({
                id: currentId++,
                ...region
            }));
            blockObjects = testData.blocks.map(blocks => ({
                id: "blockObj" + currentId++,
                ...blocks
            }));
            // loadImg = testData.imageUrl;// ì´ë¯¸ì§€ë„ í• ë‹¹
            loadBackground(testData.imageUrl);
            
        }
    });
};

// ë°°ê²½ ì´ë¯¸ì§€ ì—¬ë°±ê³¼ í¬ê¸°ì¡°ì ˆì„ ìœ„í•´ ì„¸íŒ…í•˜ëŠ” í•¨ìˆ˜
function loadBackground(imageUrl) {
    backgroundImg = new Image();
    backgroundImg.onload = function () {
        // ìº”ë²„ìŠ¤ í¬ê¸° ì¬ì„¤ì • ë° ë³€í™˜(transform) ì„¤ì •
        const parent = canvas.parentElement;

        // ìº”ë²„ìŠ¤ì˜ í¬ê¸°ë¥¼ ë¶€ëª¨ íƒœê·¸ì— ë§ì¶¤
        canvas.width = parent.clientWidth;
        canvas.height = parent.clientHeight;

        const imgAspect = backgroundImg.width / backgroundImg.height;   // ì´ë¯¸ì§€ ë¹„ìœ¨(1ì´ë©´ ì •ì‚¬ê°, 1ë³´ë‹¤í¬ë©´ ê°€ë¡œì§ì‚¬ê°, ì ìœ¼ë©´ ì„¸ë¡œ ì§ì‚¬ê°)
        const canvasAspect = canvas.width / canvas.height;  // ìº”ë²„ìŠ¤ ë¹„ìœ¨(1ì´ë©´ ì •ì‚¬ê°, 1ë³´ë‹¤í¬ë©´ ê°€ë¡œì§ì‚¬ê°, ì ìœ¼ë©´ ì„¸ë¡œ ì§ì‚¬ê°)

        // ìº”ë²„ìŠ¤ ì—¬ë°± (í”½ì…€ ë‹¨ìœ„)
        const margin = 50;
        const innerWidth = canvas.width - margin * 2;    // ìº”ë²„ìŠ¤ ì „ì²´ ë„ˆë¹„ - ì–‘ìª½ ì—¬ë°±(ì¢Œ+ìš°)
        const innerHeight = canvas.height - margin * 2;  // ìº”ë²„ìŠ¤ ì „ì²´ ë†’ì´ - ì–‘ìª½ ì—¬ë°±(ìƒ+í•˜)
        let scaleFactor;

        if   (imgAspect > canvasAspect) scaleFactor = innerWidth / backgroundImg.width; // ê°€ë¡œê°€ ë” ê¸´ ê²½ìš° â†’ ê°€ë¡œì— ë§ì¶”ë˜ ì—¬ë°± ê³ ë ¤
        else scaleFactor = innerHeight / backgroundImg.height;  // ì„¸ë¡œê°€ ë” ê¸´ ê²½ìš° â†’ ì„¸ë¡œì— ë§ì¶”ë˜ ì—¬ë°± ê³ ë ¤

        bgW = backgroundImg.width * scaleFactor;   // ìº”ë²„ìŠ¤ ì•ˆì— ë§ì¶°ì§„ ì´ë¯¸ì§€ ê°€ë¡œ í¬ê¸°
        bgH = backgroundImg.height * scaleFactor;  // ìº”ë²„ìŠ¤ ì•ˆì— ë§ì¶°ì§„ ì´ë¯¸ì§€ ì„¸ë¡œ í¬ê¸°
        bgX = (canvas.width - bgW) / 2;            // ìº”ë²„ìŠ¤ ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•œ Xì¢Œí‘œ
        bgY = (canvas.height - bgH) / 2;           // ìº”ë²„ìŠ¤ ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•œ Yì¢Œí‘œ

        // ì´ë¯¸ì§€ì˜ ì¶•ì†Œ/í™•ëŒ€ ë¹„ìœ¨
        window.imageRatio = {
            x: backgroundImg.width / bgW,//x ë¹„ìœ¨ = ì›ë³¸ ì´ë¯¸ì§€ ê°€ë¡œ / ì‹¤ì œ ê·¸ë ¤ì§„ ê°€ë¡œ
            y: backgroundImg.height / bgH//y ë¹„ìœ¨ = ì›ë³¸ ì´ë¯¸ì§€ ì„¸ë¡œ / ì‹¤ì œ ê·¸ë ¤ì§„ ì„¸ë¡œ
        };
        // ì´ë¯¸ì§€ ë¡œë“œ í›„ ê¸°ì¡´ ì˜ì—­ ë°ì´í„° ë¡œë“œ ë° ì¢Œí‘œ ë³€í™˜
        if (regionObjects.length > 0) {
            initData(regionObjects);// ì„œë²„ì—ì„œ ë°›ì€ ì˜ì—­ ë°ì´í„°ë¥¼ ì‹¤ì œ ìº”ë²„ìŠ¤ ë‚´ ì¶•ì†Œ/í™•ëŒ€ëœ ê·¸ë¦¼ì•ˆì— ê·¸ë¦´ ìˆ˜ ìˆë„ë¡ ì¬ì •ì˜í•˜ëŠ” í•¨ìˆ˜
            setValue(selectedObject);
        }
        draw(); // ì‹¤ì œ ìº”ë²„ìŠ¤ ì—¬ë°±ê³¼ í¬ê¸°ì¡°ì ˆì„ ì»¨íŠ¸ë¡¤í•˜ëŠ” í•¨ìˆ˜
    };

    backgroundImg.onerror = () => {
        console.error("ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:", imageUrl);
        draw(); // ì‹¤ì œ ìº”ë²„ìŠ¤ ì—¬ë°±ê³¼ í¬ê¸°ì¡°ì ˆì„ ì»¨íŠ¸ë¡¤í•˜ëŠ” í•¨ìˆ˜
    };
    backgroundImg.src = imageUrl;
}

/* --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ --- */

// ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬ ëª¨ìŒ
btnZoomIn.onclick = () => zoomAt(1.2, canvas.width / 2, canvas.height / 2); // í™•ëŒ€ í´ë¦­ ì‹œ
btnZoomOut.onclick = () => zoomAt(0.8, canvas.width / 2, canvas.height / 2);// ì¶•ì†Œ í´ë¦­ ì‹œ
btnPan.onclick = () => {
    mode = 'pan'; // ì´ë™ ëª¨ë“œ ì„¤ì •
    draw();
};
btnSelect.onclick = () => { // ì„ íƒ ë²„íŠ¼ í´ë¦­ ì‹œ
    selectedObject = null;
    initValue();
    mode = null; // 'ì„ íƒ' ëª¨ë“œ
};
btnReset.onclick = () => { // ì´ˆê¸°í™” ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰
    // ì¤Œ ë° ì´ë™ ì´ˆê¸°í™”
    scale = 1;
    offsetX = 0;
    offsetY = 0;
    selectedObject = null;
    initValue();
    highlightedBlock = null;// ë¸”ë¡ í…Œì´ë¸” ì´ˆê¸°í™” ë° í•˜ì´ë¼ì´íŠ¸ëœ ë¸”ë¡ ì œê±°
    fillBlockTable(); // í…Œì´ë¸” ì´ˆê¸°í™”
    draw();
};


// ì…ë ¥ í•„ë“œ ë³€ê²½ ì‹œ ì„ íƒëœ ê°ì²´ ì†ì„± ì—…ë°ì´íŠ¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
sectionNameInput.addEventListener("input", (e) => { // ì˜ì—­ ëª… ë³€ê²½ ì‹œ
    if (selectedObject) selectedObject.sectionName = e.target.value;
});
sectionTypeSelect.addEventListener("change", (e) => {// ì˜ì—­ë¶„ë¦¬ íƒ€ì… ì„ íƒ ì‹œ
    if (selectedObject) selectedObject.sectionType = e.target.value;
});
separateBlockTypeSelect.addEventListener("change", (e) => { // ì˜ì—­ ë¸”ë¡í™” íƒ€ì… ì„ íƒ ì‹œ
    if (selectedObject) selectedObject.separateBlockType = e.target.value;
});

// ìº”ë²„ìŠ¤ ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
canvas.addEventListener("mousedown", handleMouseDown);  // ìº”ë²„ìŠ¤ ë‚´ì—ì„œ mouseDown ì´ë²¤íŠ¸ ë°œìƒ ì‹œ í•¨ìˆ˜ ì‹¤í–‰;
canvas.addEventListener("wheel", handleWheel, {
    passive: false
});
// ë¸”ë¡ í…Œì´ë¸”ì˜ í–‰ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
blockTableBody.addEventListener("click", (e) => {
    const row = e.target.closest('tr');
    if (!row) {
        return;
    }

    // ì´ì „ì— í•˜ì´ë¼ì´íŠ¸ëœ í–‰ì˜ í´ë˜ìŠ¤ ì œê±°
    const allRows = blockTableBody.querySelectorAll('tr');
    allRows.forEach(r => r.classList.remove('highlighted-row'));

    if (row && row.dataset.blockClassId) {
        // ìœ íš¨í•œ ë¸”ë¡ í–‰ì„ í´ë¦­í–ˆì„ ë•Œ
        const blockClassId = row.dataset.blockClassId;
        highlightedBlock = blockObjects.find(
            (obj) => (obj.blockClassId == blockClassId)
        );
        // í•˜ì´ë¼ì´íŠ¸ í´ë˜ìŠ¤ ì¶”ê°€
        row.classList.add('highlighted-row');
    } else {
        // í…Œì´ë¸”ì˜ í–‰ì´ ì•„ë‹Œ ë‹¤ë¥¸ ë¶€ë¶„ì„ í´ë¦­í–ˆì„ ë•Œ (ì„ íƒ í•´ì œ)
        highlightedBlock = null;
    }
    
    // ìº”ë²„ìŠ¤ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    draw();
});
blockTableBody.addEventListener("change", (e) => {
    const target = e.target;
    const row = target.closest('tr');

    // input ë˜ëŠ” select íƒœê·¸ê°€ ë³€ê²½ë˜ì—ˆì„ ë•Œë§Œ ì²˜ë¦¬
    if (target.tagName === 'SELECT' || target.tagName === 'INPUT') {
        const blockClassId = target.dataset.blockClassId;
        const dataType = target.dataset.type;

        if (blockClassId && dataType) {
            const blockToUpdate = blockObjects.find(
                (obj) => (obj.blockClassId == blockClassId)
            );

            if (blockToUpdate) {
                // í•´ë‹¹ ë°ì´í„° íƒ€ì…ì— ë§ì¶° ê°’ ì—…ë°ì´íŠ¸
                blockToUpdate[dataType] = target.value;
            }
        }
    }
    
    // ë¸”ë¡ êµ¬ë¶„(select)ì´ ë³€ê²½ë˜ì—ˆì„ ë•Œ ì…ë ¥ í•„ë“œ ìƒíƒœ ì œì–´
    if (target.dataset.type === 'blockType') {
        const row = target.closest('tr');
        const textInput = row.querySelector('[data-type="defaultText"]');
        const tableInput = row.querySelector('[data-type="tableName"]');
        const columnInput = row.querySelector('[data-type="columnName"]');
        const blockType = target.value;

        if (blockType === 'key') {
            textInput.readOnly = false;
            tableInput.readOnly = true;
            columnInput.readOnly = true;
        } else if (blockType === 'val') {
            textInput.readOnly = true;
            tableInput.readOnly = false;
            columnInput.readOnly = false;
        } else if (blockType === 'del') {
            textInput.readOnly = true;
            tableInput.readOnly = true;
            columnInput.readOnly = true;
        } else { // ê¸°íƒ€ ì„ íƒ
            textInput.readOnly = true;
            tableInput.readOnly = true;
            columnInput.readOnly = true;
        }
    }
});
//ë’¤ë¡œ ë²„íŠ¼ í´ë¦­ ì‹œ ë’¤ë¡œ ê°€ê¸° ë°˜ì‘
btnBack.addEventListener("click", function(e){
    e.preventDefault();
        if(confirm('ì €ì¥í•˜ì§€ ì•Šê³  ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')){
            history.back();
        }
});
// ì°½ í¬ê¸° ë³€ê²½ ì‹œ ìº”ë²„ìŠ¤ í¬ê¸° ì—…ë°ì´íŠ¸ ë° ë·° ìœ ì§€
let prevCanvasWidth = canvas.clientWidth;
let prevCanvasHeight = canvas.clientHeight;
window.addEventListener('resize', () => {
    // ì´ì „ ìº”ë²„ìŠ¤ í¬ê¸°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë·°ì˜ ì¤‘ì‹¬ì ì„ ê³„ì‚°
    const centerX_image = (prevCanvasWidth / 2 - offsetX) / scale;
    const centerY_image = (prevCanvasHeight / 2 - offsetY) / scale;
    
    // ìº”ë²„ìŠ¤ í¬ê¸°ë¥¼ ìƒˆë¡œìš´ ì°½ í¬ê¸°ì— ë§ì¶° ì—…ë°ì´íŠ¸
    canvas.width = canvas.clientWidth;
    canvas.height = canvas.clientHeight;
    
    // ìƒˆë¡œìš´ ìº”ë²„ìŠ¤ í¬ê¸°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¤‘ì‹¬ì  ìœ„ì¹˜ë¥¼ ë‹¤ì‹œ ê³„ì‚°í•˜ì—¬ offsetX, offsetYë¥¼ ì—…ë°ì´íŠ¸
    offsetX = canvas.width / 2 - centerX_image * scale;
    offsetY = canvas.height / 2 - centerY_image * scale;
    
    // ì´ì „ ìº”ë²„ìŠ¤ í¬ê¸° ì—…ë°ì´íŠ¸
    prevCanvasWidth = canvas.clientWidth;
    prevCanvasHeight = canvas.clientHeight;
    
    // ì—…ë°ì´íŠ¸ëœ ê°’ìœ¼ë¡œ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    draw();
});

// --- í•µì‹¬ í•¨ìˆ˜ ---

/**
 * ì„œë²„ì—ì„œ ë°›ì€ ì˜ì—­ ë°ì´í„°ë¥¼ ì‹¤ì œ ìº”ë²„ìŠ¤ ë‚´ ì¶•ì†Œ/í™•ëŒ€ëœ ê·¸ë¦¼ì•ˆì— ê·¸ë¦´ ìˆ˜ ìˆë„ë¡ ì¬ì •ì˜í•˜ëŠ” í•¨ìˆ˜
 * @param {Array<Object>} data ì„œë²„ì—ì„œ ë°›ì€ ì˜ì—­ ë°ì´í„° ë°°ì—´
 */
const initData = (data) => {
    regionObjects = data.map((d, index) => {
        return {
            id: `obj${index + 1}`,
            rect: {//  ì„œë²„ì— ì €ì¥ëœ ì¢Œí‘œëŠ” ì›ë³¸ ì´ë¯¸ì§€ì˜ í¬ê¸°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•˜ë©°, ìº”ë²„ìŠ¤ì— ë§ê²Œ ì¶•ì†Œ/í™•ëŒ€ëœ ì´ë¯¸ì§€ë¥¼ ê³ ë ¤í•˜ì—¬ ì¢Œí‘œë¥¼ ë³€í™˜
                x: (d.rect.x / window.imageRatio.x) + bgX, // ( ì‹¤ì œ ì´ë¯¸ì§€ê¸°ì¤€ x ì¢Œí‘œ / ì´ë¯¸ì§€ ì‹¤ì œ x ì¢Œí‘œ) + ìº”ë²„ìŠ¤ ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•œ x ì¢Œí‘œ
                y: (d.rect.y / window.imageRatio.y) + bgY, // ( ì‹¤ì œ ì´ë¯¸ì§€ê¸°ì¤€ y ì¢Œí‘œ / ì´ë¯¸ì§€ ì‹¤ì œ y ì¢Œí‘œ) + ìº”ë²„ìŠ¤ ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•œ y ì¢Œí‘œ
                w: d.rect.w / window.imageRatio.x,// ì‹¤ì œ ì´ë¯¸ì§€ê¸°ì¤€ ë„ˆë¹„ / ì´ë¯¸ì§€ ì‹¤ì œ ë„ˆë¹„
                h: d.rect.h / window.imageRatio.y// ì‹¤ì œ ì´ë¯¸ì§€ê¸°ì¤€ ë†’ì´ / ì´ë¯¸ì§€ ì‹¤ì œ ë†’ì´
            },
            sectionName: d.sectionName,
            sectionType: d.sectionType,
            separateBlockType: d.separateBlockType,
            // ì¡°ê±´ë¶€ë¡œ sectionClassId ì¶”ê°€
            ...(d.sectionClassId ? { sectionClassId: d.sectionClassId } : {})
        };
    });
    currentId = regionObjects.length + 1;
};

// ì…ë ¥ í•„ë“œë¥¼ ì´ˆê¸°í™”í•˜ëŠ” í•¨ìˆ˜
function initValue() {
    objectIdBox.value = "";
    rectInput.value = "";
    sectionNameInput.value = "";
    sectionTypeSelect.value = "";
    separateBlockTypeSelect.value = "";
}

// ì„ íƒëœ ê°ì²´ì˜ ì •ë³´ë¥¼ ì…ë ¥ í•„ë“œì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
function setValue(obj) {
    if (!obj) {
        initValue();
        return;
    }

    // ë°°ê²½ ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ ì¢Œí‘œ ë³€í™˜ì„ ìˆ˜í–‰í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, ë³€í™˜ ì—†ì´ ê°’ì„ ì„¤ì •í•©ë‹ˆë‹¤.
    if (!backgroundImg) {
        objectIdBox.value = obj.id;
        rectInput.value = `(${obj.rect.x.toFixed(2)},${obj.rect.y.toFixed(2)},${obj.rect.w.toFixed(2)},${obj.rect.h.toFixed(2)})`;
    } else {
        const imgX = (obj.rect.x - bgX) * window.imageRatio.x;
        const imgY = (obj.rect.y - bgY) * window.imageRatio.y;
        const imgW = obj.rect.w * window.imageRatio.x;
        const imgH = obj.rect.h * window.imageRatio.y;
        
        objectIdBox.value = obj.id;
        rectInput.value = `(${imgX.toFixed(2)},${imgY.toFixed(2)},${imgW.toFixed(2)},${imgH.toFixed(2)})`;
    }
    
    sectionNameInput.value = obj.sectionName || "";
    sectionTypeSelect.value = obj.sectionType || "";
    separateBlockTypeSelect.value = obj.separateBlockType || "";
}

/**
 * ê°ì²´ì˜ 8ê°œ í¬ê¸° ì¡°ì ˆ í•¸ë“¤ ì¢Œí‘œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
 * @param {object} obj í•¸ë“¤ì„ ê°€ì ¸ì˜¬ ê°ì²´.
 * @returns {Array<Array<number>>} í•¸ë“¤ ì¢Œí‘œ [x, y]ì˜ ë°°ì—´.
 */
function getHandles(obj) {
    const { x, y, w, h } = obj.rect;
    return [
        [x, y],
        [x + w / 2, y],
        [x + w, y],
        [x, y + h / 2],
        [x + w, y + h / 2],
        [x, y + h],
        [x + w / 2, y + h],
        [x + w, y + h],
    ];
}

/**
 * ì£¼ì–´ì§„ í•¸ë“¤ ì¸ë±ìŠ¤ì— ëŒ€í•œ ì»¤ì„œ ìŠ¤íƒ€ì¼ì„ ê²°ì •í•©ë‹ˆë‹¤.
 * @param {number} index í•¸ë“¤ ì¸ë±ìŠ¤.
 * @returns {string} CSS ì»¤ì„œ ìŠ¤íƒ€ì¼.
 */
function getCursorForHandle(index) {
    switch (index) {
        case 0:
        case 7:
        return "nwse-resize";
        case 1:
        case 6:
        return "ns-resize";
        case 2:
        case 5:
        return "nesw-resize";
        case 3:
        case 4:
        return "ew-resize";
        default:
        return "default";
    }
}

/**
 * ì„ íƒëœ ì˜ì—­(selectedObject)ì˜ ë¸”ë¡ ì •ë³´ë¥¼ í…Œì´ë¸”ì— ë Œë”ë§í•œë‹¤.
 * - ì˜ì—­ì´ ì—†ìœ¼ë©´ "í˜„ì¬ ì„ íƒí•œ ì˜ì—­ì´ ì—†ìŠµë‹ˆë‹¤." ë©”ì‹œì§€ë¥¼ í‘œì‹œ
 * - ì˜ì—­ì€ ìˆì§€ë§Œ ë¸”ë¡ì´ ì—†ìœ¼ë©´ "í•´ë‹¹ ì˜ì—­ì— ë¸”ë¡ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤." ë©”ì‹œì§€ë¥¼ í‘œì‹œ
 * - ë¸”ë¡ì´ ì¡´ì¬í•˜ë©´ ê° ë¸”ë¡ì˜ ì†ì„±ì„ í–‰ìœ¼ë¡œ ìƒì„±í•˜ì—¬ blockTableBodyì— ì‚½ì…
 */
function fillBlockTable(){
    // ì„ íƒëœ ì˜ì—­ì´ ìˆì„ ê²½ìš° ë¸”ë¡ ì •ë³´ í‘œì‹œ
    if(selectedObject){
        const selectedBlocks = blockObjects.filter(obj => selectedObject.sectionClassId === obj.sectionClassId);
        
        blockTableBody.innerHTML = ''; 

        if (selectedBlocks.length === 0) {
            blockTableBody.innerHTML = '<tr><td colspan="5">í•´ë‹¹ ì˜ì—­ì— ë¸”ë¡ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</td></tr>';
        } else {
            selectedBlocks.forEach(block => {
                const row = document.createElement('tr');
                row.dataset.row = block.blockRowNum;
                row.dataset.col = block.blockColNum;
                // blockClassId ì‚¬ìš©
                const blockClassId = block.blockClassId;
                row.dataset.blockClassId = blockClassId;
                
                row.innerHTML = `
                    <td>${block.blockRowNum || ''}/${block.blockColNum || ''}</td>
                    <td>
                        <select class="form-control" data-type="blockType" data-block-class-id="${blockClassId}">
                            <option value="" ${block.blockType === '' ? 'selected' : ''}>ì„ íƒ</option>
                            <option value="key" ${block.blockType === 'key' ? 'selected' : ''}>í‚¤</option>
                            <option value="val" ${block.blockType === 'val' ? 'selected' : ''}>ê°’</option>
                            <option value="del" >ì‚­ì œ</option>
                        </select>
                    </td>
                    <td><input type="text" class="form-control" data-type="defaultText" data-block-class-id="${blockClassId}" value="${block.defaultText || ''}" ${block.blockType === 'val' ? 'readonly' : ''}></td>
                    <td><input type="text" class="form-control" data-type="tableName" data-block-class-id="${blockClassId}" value="${block.tableName || ''}" ${block.blockType === 'key' ? 'readonly' : ''}/></td>
                    <td><input type="text" class="form-control" data-type="columnName" data-block-class-id="${blockClassId}" value="${block.columnName || ''}" ${block.blockType === 'key' ? 'readonly' : ''}/></td>
                `;
                blockTableBody.appendChild(row);
            });
        }
    } else {
        blockTableBody.innerHTML = '<tr><td colspan="5">í˜„ì¬ ì„ íƒí•œ ì˜ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    }
}

/**
 * ìº”ë²„ìŠ¤ì— ëª¨ë“  ê°ì²´ë¥¼ ê·¸ë¦¬ê³ , ì„ íƒëœ ê°ì²´ì— ëŒ€í•´ì„œëŠ” í¬ê¸° ì¡°ì ˆ í•¸ë“¤ì„ ê·¸ë¦½ë‹ˆë‹¤.
 */
function drawObjects() {
    regionObjects.forEach((obj) => {
        // ë©”ì¸ ì‚¬ê°í˜• ê·¸ë¦¬ê¸°
        if (selectedObject === obj) {
            // ì„ íƒëœ ê°ì²´ëŠ” ì—°í•œ ë…¸ë€ìƒ‰ìœ¼ë¡œ ì±„ìš°ê¸°
            //ctx.fillStyle = "rgba(255, 255, 128, 0.5)"; ì´ì „ ì½”ë“œ ì£¼ì„ì²˜ë¦¬
            ctx.fillStyle = "rgba(220, 220, 30, 0.13)"; // ì—°í•œ ë…¸ë€ìƒ‰
        } else {
            // ì„ íƒë˜ì§€ ì•Šì€ ê°ì²´ëŠ” ê¸°ì¡´ ìƒ‰ìƒ ìœ ì§€
            ctx.fillStyle = "rgba(128, 0, 128, 0.3)";
        }

        ctx.fillRect(obj.rect.x, obj.rect.y, obj.rect.w, obj.rect.h);
        ctx.strokeStyle = "black";
        ctx.strokeRect(obj.rect.x, obj.rect.y, obj.rect.w, obj.rect.h);
    });
}

// ì´ë¯¸ì§€ ë¹„ìœ¨ì„ ê¸°ì¤€ìœ¼ë¡œ ìº”ë²„ìŠ¤ì— ë¸”ë¡ì„ ê·¸ë¦¬ëŠ” í•¨ìˆ˜
function drawHighlightedBlock() {
    const block = highlightedBlock;
    // block, blockBox, backgroundImg, window.imageRatio ë³€ìˆ˜ê°€ ëª¨ë‘ ìœ íš¨í•œì§€ í™•ì¸
    if (!block || !block.blockBox || !backgroundImg || !window.imageRatio) {
        return;
    }

    // ìº”ë²„ìŠ¤ì— ê·¸ë ¤ì§„ ì´ë¯¸ì§€ì˜ ì‹¤ì œ í¬ê¸°ë¥¼ ê³„ì‚°
    // window.imageRatio.xëŠ” (ì›ë³¸ ê°€ë¡œ / ê·¸ë ¤ì§„ ê°€ë¡œ) ì´ë¯€ë¡œ, ì—­ìˆ˜ë¥¼ ì·¨í•´ì•¼ í•¨
    const scaleX = 1 / window.imageRatio.x;
    const scaleY = 1 / window.imageRatio.y;
    
    // loadBackground í•¨ìˆ˜ì—ì„œ ê³„ì‚°ëœ ì´ë¯¸ì§€ì˜ ì‹œì‘ì  (ì¤‘ì•™ ì •ë ¬)
    const imgDrawX = bgX;
    const imgDrawY = bgY;

    const [x, y, w, h] = block.blockBox;

    // ì›ë³¸ ì¢Œí‘œë¥¼ ìº”ë²„ìŠ¤ ì¢Œí‘œë¡œ ë³€í™˜
    const canvasX = x * scaleX + imgDrawX;
    const canvasY = y * scaleY + imgDrawY;
    const canvasW = w * scaleX;
    const canvasH = h * scaleY;

    // ë¹¨ê°„ìƒ‰ ì™¸ê³½ì„  ê·¸ë¦¬ê¸°
    ctx.save();
    ctx.strokeStyle = "red";
    ctx.lineWidth = 1;
    ctx.strokeRect(canvasX, canvasY, canvasW, canvasH);
    ctx.restore();
}

/**
 * ë©”ì¸ ê·¸ë¦¬ê¸° í•¨ìˆ˜. ìº”ë²„ìŠ¤ë¥¼ ì§€ìš°ê³ , ë³€í™˜ì„ ì ìš©í•˜ê³ ,
 * ë°°ê²½ ì´ë¯¸ì§€ì™€ ëª¨ë“  ê°ì²´ë¥¼ ê·¸ë¦½ë‹ˆë‹¤.
 */
function draw() {
    ctx.setTransform(scale, 0, 0, scale, offsetX, offsetY);
    // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
    ctx.clearRect(-offsetX / scale, -offsetY / scale, canvas.width / scale, canvas.height / scale);
    // ë°°ê²½ ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
    if (backgroundImg) {
        ctx.drawImage(backgroundImg, bgX, bgY, bgW, bgH);
    }
    // ì‚¬ê°í˜• ê°ì²´ ê·¸ë¦¬ê¸°
    drawObjects();
     // í•˜ì´ë¼ì´íŠ¸ëœ ë¸”ë¡ì´ ìˆìœ¼ë©´ ê·¸ë¦¬ê¸°
    if (highlightedBlock) {
        drawHighlightedBlock();
    }
    // ì¤Œ ë°°ìœ¨ ì—…ë°ì´íŠ¸
    zoomLabel.textContent = "Zoom level: " + scale.toFixed(4);
}

/**
 * ë§ˆìš°ìŠ¤ ì¢Œí‘œë¥¼ í™”ë©´ ê³µê°„ì—ì„œ ìº”ë²„ìŠ¤ ê³µê°„ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
 * í™•ëŒ€/ì¶•ì†Œ ë° íŒ¨ë‹ì„ ê³ ë ¤í•©ë‹ˆë‹¤.
 * @param {MouseEvent} e ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ê°ì²´.
 * @returns {Array<number>} ìº”ë²„ìŠ¤ ê³µê°„ì˜ [x, y] ì¢Œí‘œ.
 */
function toCanvasCoord(e) {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    return [(x - offsetX) / scale, (y - offsetY) / scale];
}

/**
 * íŠ¹ì • ì§€ì ì„ ì¤‘ì‹¬ìœ¼ë¡œ ìº”ë²„ìŠ¤ë¥¼ í™•ëŒ€ ë˜ëŠ” ì¶•ì†Œí•©ë‹ˆë‹¤.
 * @param {number} factor í™•ëŒ€/ì¶•ì†Œ ë°°ìœ¨ (ì˜ˆ: 1.2ëŠ” í™•ëŒ€).
 * @param {number} cx í™•ëŒ€/ì¶•ì†Œ ì¤‘ì‹¬ì ì˜ X ì¢Œí‘œ (ìº”ë²„ìŠ¤ ê³µê°„).
 * @param {number} cy í™•ëŒ€/ì¶•ì†Œ ì¤‘ì‹¬ì ì˜ Y ì¢Œí‘œ (ìº”ë²„ìŠ¤ ê³µê°„).
 */
function zoomAt(factor, cx, cy) {
    const prevScale = scale;
    let newScale = scale * factor;

    if (newScale < MIN_SCALE) newScale = MIN_SCALE;
    if (newScale > MAX_SCALE) newScale = MAX_SCALE;

    offsetX = cx - (cx - offsetX) * (newScale / prevScale);
    offsetY = cy - (cy - offsetY) * (newScale / prevScale);

    scale = newScale;
    draw();
}

const setCoordData = () => {
     // 1. í˜„ì¬ ì„ íƒëœ ê°ì²´ê°€ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
    if (!selectedObject) {
        console.log("ë¨¼ì € ì˜ì—­ì„ ì„ íƒí•˜ì„¸ìš”.");
        return;
    }

    // 2. ì…ë ¥ í•„ë“œì—ì„œ ê°’ë“¤ì„ ê°€ì ¸ì™€ ìˆ«ìë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
    const newImgX = parseFloat(document.getElementById('x_coord').value);
    const newImgY = parseFloat(document.getElementById('y_coord').value);
    const newWidth = parseFloat(document.getElementById('width').value);
    const newHeight = parseFloat(document.getElementById('height').value);

    // 3. ì…ë ¥ ê°’ì´ ìœ íš¨í•œì§€ í™•ì¸í•©ë‹ˆë‹¤.
    if (isNaN(newImgX) || isNaN(newImgY) || isNaN(newWidth) || isNaN(newHeight) || newWidth <= 0 || newHeight <= 0) {
        console.log("ìœ íš¨í•œ ìˆ«ì ê°’ì„ ì…ë ¥í•˜ì„¸ìš”. ë„ˆë¹„ì™€ ë†’ì´ëŠ” 0ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.");
        return;
    }

    // 4. ì…ë ¥ëœ ì´ë¯¸ì§€ ê¸°ì¤€ ì¢Œí‘œë¥¼ ìº”ë²„ìŠ¤ ì¢Œí‘œë¡œ ë³€í™˜í•˜ì—¬ ê°ì²´ì— ì ìš©í•©ë‹ˆë‹¤.
    // ë°°ê²½ ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ ë³€í™˜ ì—†ì´ ì§ì ‘ ì„¤ì •
    if (backgroundImg) {
        // ì´ë¯¸ì§€ ê¸°ì¤€ ì¢Œí‘œë¥¼ ìº”ë²„ìŠ¤ ì¢Œí‘œë¡œ ë³€í™˜
        selectedObject.rect.x = (newImgX / window.imageRatio.x) + bgX;
        selectedObject.rect.y = (newImgY / window.imageRatio.y) + bgY;
        selectedObject.rect.w = newWidth / window.imageRatio.x;
        selectedObject.rect.h = newHeight / window.imageRatio.y;
    } else {
        selectedObject.rect.x = newImgX;
        selectedObject.rect.y = newImgY;
        selectedObject.rect.w = newWidth;
        selectedObject.rect.h = newHeight;
    }

    // 5. ë³€ê²½ëœ ê°’ìœ¼ë¡œ ì…ë ¥ í•„ë“œë¥¼ ì—…ë°ì´íŠ¸í•˜ê³  ë‹¤ì‹œ ê·¸ë¦½ë‹ˆë‹¤.
    setValue(selectedObject);
    draw();
}

// --- ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---

// ë§ˆìš°ìŠ¤ ë‹¤ìš´ ì´ë²¤íŠ¸: ë“œë˜ê·¸ ì‹œì‘, ê°ì²´ ì„ íƒ ë“±
function handleMouseDown(e) {
    const [mx, my] = toCanvasCoord(e);
    startX = mx;
    startY = my;

    const prevSelectedObject = selectedObject; // ì´ì „ ì„ íƒ ê°ì²´ ì €ì¥
    if (mode === 'pan') {
        // 'ì´ë™' ëª¨ë“œì¼ ê²½ìš°: ì„ íƒ ìƒíƒœ ìœ ì§€í•˜ê³  íŒ¨ë‹ ì‹œì‘
        dragging = true;
        dragType = "pan";
        dragOffsetX = e.clientX;
        dragOffsetY = e.clientY;
    } else {
    selectedObject = null;
    initValue();
    for (const obj of regionObjects) {
        if (
            mx >= obj.rect.x &&
            mx <= obj.rect.x + obj.rect.w &&
            my >= obj.rect.y &&
            my <= obj.rect.y + obj.rect.h
        ) {
            selectedObject = obj;
            setValue(obj);
            break;
        }
    }

    // ì„ íƒí•œ ì˜ì—­ì´ ë°”ë€Œë©´ í•˜ì´ë¼ì´íŠ¸ëœ ë¸”ë¡ê³¼ ë¸”ë¡ í…Œì´ë¸”ì„ ì´ˆê¸°í™”
    if (selectedObject !== prevSelectedObject) {
        highlightedBlock = null;
        fillBlockTable(); // ğŸ‘ˆ ì„ íƒëœ ê°ì²´ê°€ ë³€ê²½ë  ë•Œë§Œ í…Œì´ë¸” ê°±ì‹ 
    }
    
    // ì´ ë¶€ë¶„ì€ ìœ ì§€í•˜ì—¬ ìº”ë²„ìŠ¤ íŒ¨ë‹(pan) ê¸°ëŠ¥ì„ ê³„ì† ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    if (selectedObject === null) {
        dragging = true;
        dragType = "pan";
        dragOffsetX = e.clientX;
        dragOffsetY = e.clientY;
        }
    }
    // ë“œë˜ê·¸ ì‹œì‘ ì‹œì—ë§Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ë™ì ìœ¼ë¡œ ì¶”ê°€
    window.addEventListener("mousemove", handleMouseMove);
    window.addEventListener("mouseup", handleMouseUp);
    draw();
};

// ë§ˆìš°ìŠ¤ ì´ë™ ì´ë²¤íŠ¸: ë“œë˜ê·¸ ì¤‘ì¸ ê°ì²´ ì´ë™, í¬ê¸° ì¡°ì ˆ ë“±
function handleMouseMove(e) {
    const [mx, my] = toCanvasCoord(e);

    if (dragging) {
        if (dragType === "pan") {
            canvas.style.cursor = 'grabbing';
            offsetX += e.clientX - dragOffsetX;
            offsetY += e.clientY - dragOffsetY;
            dragOffsetX = e.clientX;
            dragOffsetY = e.clientY;
        }
        draw();
    } else {
        updateCursor(mx, my);
        draw();
    }
};

// ë§ˆìš°ìŠ¤ ì—… ì´ë²¤íŠ¸: ë“œë˜ê·¸ ì¢…ë£Œ
function handleMouseUp() {
    setValue(selectedObject);
    dragging = false;
    dragType = null;
    
    // ë“œë˜ê·¸ ì¢…ë£Œ ì‹œì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì œê±°
    window.removeEventListener("mousemove", handleMouseMove);
    window.removeEventListener("mouseup", handleMouseUp);
};

// ë§ˆìš°ìŠ¤ íœ  ì´ë²¤íŠ¸: í™•ëŒ€/ì¶•ì†Œ
function handleWheel(e) {
    e.preventDefault();
    let factor = e.deltaY < 0 ? 1.1 : 0.9;
    const [cx, cy] = toCanvasCoord(e);
    zoomAt(factor, cx, cy);
};

/**
 * ìƒˆ ë§ˆìš°ìŠ¤ ì¢Œí‘œì™€ í˜„ì¬ ë“œë˜ê·¸ ì¤‘ì¸ í•¸ë“¤ì„ ê¸°ë°˜ìœ¼ë¡œ ì„ íƒëœ ê°ì²´ì˜ í¬ê¸°ë¥¼ ì¡°ì ˆí•©ë‹ˆë‹¤.
 * @param {number} mx ìƒˆ ë§ˆìš°ìŠ¤ì˜ X ì¢Œí‘œ.
 * @param {number} my ìƒˆ ë§ˆìš°ìŠ¤ì˜ Y ì¢Œí‘œ.
 */
function resizeObject(mx, my) {
    const rect = selectedObject.rect;
    const oldX = rect.x;
    const oldY = rect.y;
    const oldW = rect.w;
    const oldH = rect.h;

    switch (hoverHandleIndex) {
    case 0: // ì™¼ìª½ ìƒë‹¨
        rect.x = mx;
        rect.y = my;
        rect.w = oldW + oldX - mx;
        rect.h = oldH + oldY - my;
        break;
    case 1: // ìƒë‹¨ ì¤‘ì•™
        rect.y = my;
        rect.h = oldH + oldY - my;
        break;
    case 2: // ì˜¤ë¥¸ìª½ ìƒë‹¨
        rect.w = mx - oldX;
        rect.y = my;
        rect.h = oldH + oldY - my;
        break;
    case 3: // ì™¼ìª½ ì¤‘ì•™
        rect.x = mx;
        rect.w = oldW + oldX - mx;
        break;
    case 4: // ì˜¤ë¥¸ìª½ ì¤‘ì•™
        rect.w = mx - oldX;
        break;
    case 5: // ì™¼ìª½ í•˜ë‹¨
        rect.x = mx;
        rect.w = oldW + oldX - mx;
        rect.h = my - oldY;
        break;
    case 6: // í•˜ë‹¨ ì¤‘ì•™
        rect.h = my - oldY;
        break;
    case 7: // ì˜¤ë¥¸ìª½ í•˜ë‹¨
        rect.w = mx - oldX;
        rect.h = my - oldY;
        break;
    }
    normalizeRect(rect);
}

/**
 * ì‚¬ê°í˜•ì˜ ë„ˆë¹„ì™€ ë†’ì´ê°€ í•­ìƒ ì–‘ìˆ˜ê°€ ë˜ë„ë¡ ì¹˜ìˆ˜ë¥¼ ì •ê·œí™”í•©ë‹ˆë‹¤.
 * @param {object} rect ì •ê·œí™”í•  ì‚¬ê°í˜• ê°ì²´.
 */
function normalizeRect(rect) {
    if (rect.w < 0) {
        rect.x += rect.w;
        rect.w = -rect.w;
    }
    if (rect.h < 0) {
        rect.y += rect.h;
        rect.h = -rect.h;
    }
}

/**
 * ë§ˆìš°ìŠ¤ê°€ í•¸ë“¤ ìœ„ì— í˜¸ë²„ë§í•˜ëŠ”ì§€ ì—¬ë¶€ì— ë”°ë¼ ìº”ë²„ìŠ¤ ì»¤ì„œë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
 * @param {number} mx ìº”ë²„ìŠ¤ ê³µê°„ì˜ ë§ˆìš°ìŠ¤ X ì¢Œí‘œ.
 * @param {number} my ìº”ë²„ìŠ¤ ê³µê°„ì˜ ë§ˆìš°ìŠ¤ Y ì¢Œí‘œ.
 */
function updateCursor(mx, my) {
    hoverHandleIndex = -1;
    let isHoveringObject = false;

    // 1. ì˜¤ë¸Œì íŠ¸ ìœ„ì— í˜¸ë²„ë§ ì¤‘ì¸ì§€ í™•ì¸
    for (const obj of regionObjects) {
        if (
        mx >= obj.rect.x &&
        mx <= obj.rect.x + obj.rect.w &&
        my >= obj.rect.y &&
        my <= obj.rect.y + obj.rect.h
        ) {
        isHoveringObject = true;
        break;
        }
    }

    // 2. í¬ê¸° ì¡°ì ˆ í•¸ë“¤ ìœ„ì— í˜¸ë²„ë§ ì¤‘ì¸ì§€ í™•ì¸
    if (selectedObject) {
        const handles = getHandles(selectedObject);
        for (let i = 0; i < handles.length; i++) {
        const p = handles[i];
        if (
            mx >= p[0] - HANDLE_SIZE &&
            mx <= p[0] + HANDLE_SIZE &&
            my >= p[1] - HANDLE_SIZE &&
            my <= p[1] + HANDLE_SIZE
        ) {
            hoverHandleIndex = i;
            break;
        }
        }
    }

    // 3. ìƒíƒœì— ë”°ë¼ ì»¤ì„œ ì„¤ì •
    if (hoverHandleIndex >= 0) {
        // í¬ê¸° ì¡°ì ˆ í•¸ë“¤ ìœ„ì— ìˆì„ ë•Œ
        canvas.style.cursor = getCursorForHandle(hoverHandleIndex);
    } else if (isHoveringObject) {
        // ì˜¤ë¸Œì íŠ¸ ìœ„ì— ìˆì„ ë•Œ
        canvas.style.cursor = "pointer";
    } else {
        // ê·¸ ì™¸ì˜ ê²½ìš° (ìº”ë²„ìŠ¤ ë°°ê²½) 'grab' ì»¤ì„œ ì‚¬ìš©
        canvas.style.cursor = "grab";
    }
}

/**
 * ì €ì¥ ì „, êµ¬ë¶„ ê°’ì— ì„ íƒìœ¼ë¡œ ë˜ì–´ ìˆëŠ” ê²½ìš° ë¸”ë¡ì„ ì‚­ì œë¥¼ í•  ê²ƒ ì¸ì§€ ê²€ì‚¬í•©ë‹ˆë‹¤.
 * í™•ì¸ ì‹œ, í•´ë‹¹ ë¸”ë¡ì€ ì‚­ì œ
 * ì·¨ì†Œ ì‹œ, ì €ì¥ ë¡œì§ ë©ˆì¶¤
 */
const dvsBlankChk = () => {
    // blockTypeì´ ë¹ˆ ê°’("")ì¸ ë¸”ë¡ì´ ìˆëŠ”ì§€ í™•ì¸
    const blnkChkObj = blockObjects.find(
        (chkObj) => chkObj.blockType == ''
    );

    // í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ confirm ë„ìš°ê¸°
    if (blnkChkObj) {
        if (confirm('êµ¬ë¶„ì´ ì…ë ¥ë˜ì§€ ì•Šì€ ë¸”ë¡ì€ ì‚­ì œë©ë‹ˆë‹¤.\nì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            // blockTypeì´ ë¹ˆ ê°’("")ì¸ ê²ƒë§Œ ì°¾ì•„ì„œ "del"ë¡œ ë°”ê¾¸ê¸°
            blockObjects
                .filter((chkObj) => chkObj.blockType === '')
                .forEach((chkObj) => {
                    chkObj.blockType = 'del';
                });
            return true; // ì €ì¥ ê³„ì† ì§„í–‰
        } else {
            return false; // ì €ì¥ ì¤‘ë‹¨
        }
    }

    return true; // blockTypeì´ ""ì¸ ê²Œ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ì €ì¥ ì§„í–‰
};

// --- ì €ì¥ ë° ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜ ---

/**
 * ì €ì¥í•˜ê¸° ì „ì— ëª¨ë“  ê°ì²´ì˜ ë°ì´í„° ìœ íš¨ì„±ì„ ê²€ì‚¬í•©ë‹ˆë‹¤.
 * @returns {boolean} ëª¨ë“  ë°ì´í„°ê°€ ìœ íš¨í•˜ë©´ true, ì•„ë‹ˆë©´ false.
 */
const validationData = () => {
    // ê° ê°ì²´ì˜ í•„ìˆ˜ ì…ë ¥ê°’(blockType, tableName, blockType)ì´ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
    for (const obj of blockObjects) {
        const blnkChkObj = regionObjects.find(
            (chkObj) => (chkObj.sectionClassId == obj.sectionClassId)
        );
        if (obj.blockType == 'val' && (!obj.tableName || !obj.columnName)) {
            // ex. í‘œ2ì˜ í–‰/ì—´ì´ 1/1ì¸ í…Œì´ë¸” í˜¹ì€ ì»¬ëŸ¼ ì…ë ¥ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”.
            alert(`${blnkChkObj.sectionName}ì˜ í–‰/ì—´ì´ ${obj.blockRowNum || ''}/${obj.blockColNum || ''}ì¸ í…Œì´ë¸” í˜¹ì€ ì»¬ëŸ¼ ì…ë ¥ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”.`);
        return false;
        }
    }
    return true;// ìœ íš¨ì„± ê²€ì‚¬ í†µê³¼
};

// ì €ì¥ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬
btnSave.addEventListener("click", (e) => {
    e.preventDefault();
    if(!dvsBlankChk()) return false; // êµ¬ë¶„ì´ ì„ íƒì¸ ê²½ìš°ì˜ ì‚­ì œí• ê²ƒì¸ì§€ ì²´í¬
    if (validationData()) { // validation
        // ìš”ì²­ ì‹œì‘ ì „ ë¡œë”© ê°œì²´ í‘œì‹œ
        // $('#react-loading').show();
        $('#loadingModal').modal('show');
        // ì €ì¥ ë²„íŠ¼ ë¹„í™œì„±í™” (ì¬í´ë¦­ ë°©ì§€)
        $('#btn_save').prop('disabled', true);
        
        const formData = new FormData();
        const data = blockObjects.map(obj => ({
            blockClassId: obj.blockClassId,
            blockType: obj.blockType,
            tableName: obj.tableName,
            columnName: obj.columnName,
            defaultText: obj.defaultText
        }));
        //formData.append("docClassId", docClassIdInput.value);
        formData.append("layoutClassId", layoutClassIdInput.value);
        formData.append("blockList", JSON.stringify(data));

        // AJAX POST ìš”ì²­ìœ¼ë¡œ ë°ì´í„° ì „ì†¡
        $.ajax({
            url: "/layout/block/"+layoutClassIdInput.value,
            type: "POST",
            dataType:"json",
            processData: false,
            contentType: false, 
            data: formData,
            success: function(res) {
                if(res.status === "success") {
                    window.location.href = res.redirect_url; // ì„œë²„ê°€ ë„˜ê²¨ì¤€ URLë¡œ ì´ë™
                } else {
                    alert("ì—ëŸ¬: " + res.message);
                }
            },
            error: function(e) {
                alert("ì €ì¥ ì¤‘ ë¬¸ì œê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
                // âœ… ì‹¤íŒ¨ ì‹œ í›„ì²˜ë¦¬ í•„ìš”
                $('#loadingModal').modal('hide');
                $('#btn_save').prop('disabled', false);
            },
            complete: function(xhr, status) {
                // successì—ì„œ ë¦¬ë‹¤ì´ë ‰íŠ¸ê°€ ë°œìƒí•˜ë©´ ì´ ì½”ë“œëŠ” ì‹¤í–‰ë˜ì§€ ì•Šì§€ë§Œ,
                // error ë˜ëŠ” res.statusê°€ successê°€ ì•„ë‹ ê²½ìš° ì‹¤í–‰ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
                if (status !== 'success' || (xhr.responseJSON && xhr.responseJSON.status !== 'success')) {
                    $('#loadingModal').modal('hide');
                    $('#btn_save').prop('disabled', false);
                }
            }
        });
    }
});

// ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹œ ë°ì´í„° ë¡œë“œ ë° ê·¸ë¦¬ê¸°
loadData();
</script>
{% endmacro %}